# ReviewMerkleService - Implementation Prompt

**Phase**: P3 (Week 18) | **Effort**: 1 semana | **Deps**: BlockchainService, bazari-fulfillment

## ðŸ“‹ Contexto

**Problema**: Reviews off-chain sem prova de integridade

**SoluÃ§Ã£o**: ReviewService + Merkle tree (update root on-chain a cada 100 reviews)

## ðŸŽ¯ Objetivo

Criar `/root/bazari/apps/api/src/services/review.service.ts` com:
- CRUD reviews (PostgreSQL)
- Merkle tree building (merkletreejs)
- Auto-update root on-chain (bazari-fulfillment.update_reviews_merkle_root)

## âœ… Checklist

```typescript
import { MerkleTree } from 'merkletreejs';
import * as crypto from 'crypto';

@Injectable()
export class ReviewService {
  async createReview(data: CreateReviewDto) {
    const review = await this.prisma.courierReview.create({ data });
    
    const count = await this.prisma.courierReview.count({
      where: { courierId: data.courierId },
    });
    
    if (count % 100 === 0) {
      await this.updateMerkleRoot(data.courierId);
    }
  }
  
  async updateMerkleRoot(courierId: string) {
    const reviews = await this.prisma.courierReview.findMany({
      where: { courierId },
      orderBy: { createdAt: 'asc' },
    });
    
    const leaves = reviews.map(r => this.hashReview(r));
    const tree = new MerkleTree(leaves, crypto.createHash('sha256'));
    const root = tree.getRoot();
    
    await this.blockchainService.updateReviewsMerkleRoot(courierWallet, root);
  }
}
```

## ðŸ¤– Prompt

```
Criar ReviewService NestJS com Merkle tree para reviews.

CHECKLIST:
âœ… /root/bazari/apps/api/src/services/review.service.ts
âœ… CRUD reviews (Prisma)
âœ… Merkle tree (merkletreejs + sha256)
âœ… Auto-update a cada 100 reviews
âœ… Integration com BlockchainService.updateReviewsMerkleRoot
âœ… Tests (review.service.spec.ts)
```

**Generated by**: Claude Code | **Version**: 1.0.0
