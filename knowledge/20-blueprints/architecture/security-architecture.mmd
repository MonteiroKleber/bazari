%% Bazari Platform - Security Architecture
graph TB
    subgraph "Perimeter Security"
        Firewall["ğŸ”¥ Firewall<br/>iptables + UFW"]
        WAF["ğŸ›¡ï¸ WAF<br/>Cloudflare WAF"]
        RateLimit["â±ï¸ Rate Limiting<br/>API throttling"]
    end

    subgraph "Transport Security"
        TLS["ğŸ”’ TLS 1.3<br/>SSL Certificates<br/>Let's Encrypt"]
        HSTS["ğŸ” HSTS<br/>Strict-Transport-Security"]
    end

    subgraph "Authentication Layer"
        SIWS["ğŸ”‘ SIWS<br/>Sign-In with Substrate<br/>Cryptographic signatures"]
        JWT["ğŸ« JWT<br/>Access tokens<br/>15 min expiry"]
        RefreshToken["ğŸ”„ Refresh Tokens<br/>SHA-256 hashed<br/>30 day expiry"]
    end

    subgraph "Authorization Layer"
        RBAC["ğŸ‘¥ RBAC<br/>Role-Based Access<br/>user/moderator/admin"]
        Middleware["ğŸ” Auth Middleware<br/>requireAuth()<br/>req.user injection"]
        OwnershipCheck["âœ… Ownership Checks<br/>userId validation"]
    end

    subgraph "Input Security"
        XSSPrevention["ğŸš« XSS Prevention<br/>Input sanitization<br/>CSP headers"]
        SQLInjection["ğŸš« SQL Injection Prevention<br/>Prisma ORM<br/>Parameterized queries"]
        ZodValidation["âœ… Zod Validation<br/>Type-safe schemas"]
    end

    subgraph "Session Security"
        NonceProtection["ğŸ”¢ Nonce Protection<br/>5 min expiry<br/>Single-use"]
        TokenRotation["ğŸ”„ Token Rotation<br/>Automatic refresh<br/>Old tokens revoked"]
        SessionRevocation["ğŸš« Session Revocation<br/>Logout + logout-all"]
    end

    subgraph "Data Security"
        Encryption["ğŸ” E2EE<br/>Chat encryption<br/>Curve25519"]
        Hashing["#ï¸âƒ£ Password Hashing<br/>No passwords!<br/>Wallet signatures only"]
        DataMasking["ğŸ­ Data Masking<br/>PII protection<br/>Sensitive fields"]
    end

    subgraph "Blockchain Security"
        SignatureVerif["âœï¸ Signature Verification<br/>@polkadot/util-crypto<br/>sr25519"]
        OnChainValidation["âœ… On-Chain Validation<br/>Substrate runtime<br/>Extrinsic verification"]
        ReplayProtection["ğŸ” Replay Protection<br/>Nonce + genesis hash"]
    end

    subgraph "API Security"
        CORS["ğŸŒ CORS<br/>Origin validation<br/>Whitelist"]
        CSP["ğŸ“‹ CSP<br/>Content-Security-Policy<br/>Restrict resources"]
        CSRF["ğŸ›¡ï¸ CSRF Protection<br/>SameSite cookies<br/>Token validation"]
    end

    subgraph "Infrastructure Security"
        SecretManagement["ğŸ”‘ Secret Management<br/>.env files<br/>Environment vars"]
        DBAccess["ğŸ—„ï¸ DB Access Control<br/>Least privilege<br/>Connection limits"]
        AuditLog["ğŸ“ Audit Logs<br/>Security events<br/>User actions"]
    end

    subgraph "Monitoring & Response"
        Intrusion["ğŸš¨ Intrusion Detection<br/>fail2ban<br/>Anomaly detection"]
        Alerts["âš ï¸ Security Alerts<br/>Prometheus alerts<br/>Admin notifications"]
        IncidentResponse["ğŸš‘ Incident Response<br/>Runbooks<br/>Escalation"]
    end

    %% Flow connections
    WAF --> Firewall
    Firewall --> RateLimit
    RateLimit --> TLS
    TLS --> HSTS

    HSTS --> SIWS
    SIWS --> JWT
    JWT --> RefreshToken

    JWT --> Middleware
    Middleware --> RBAC
    RBAC --> OwnershipCheck

    Middleware --> XSSPrevention
    Middleware --> SQLInjection
    Middleware --> ZodValidation

    SIWS --> NonceProtection
    JWT --> TokenRotation
    RefreshToken --> SessionRevocation

    Middleware --> Encryption
    Middleware --> Hashing
    Middleware --> DataMasking

    SIWS --> SignatureVerif
    SignatureVerif --> OnChainValidation
    SIWS --> ReplayProtection

    HSTS --> CORS
    HSTS --> CSP
    HSTS --> CSRF

    Middleware --> SecretManagement
    Middleware --> DBAccess
    Middleware --> AuditLog

    AuditLog --> Intrusion
    Intrusion --> Alerts
    Alerts --> IncidentResponse

    %% Styling
    classDef perimeterStyle fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef transportStyle fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef authStyle fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px
    classDef authzStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef inputStyle fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    classDef sessionStyle fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    classDef dataStyle fill:#e0f2f1,stroke:#00695c,stroke-width:2px
    classDef blockchainStyle fill:#fce4ec,stroke:#ad1457,stroke-width:2px
    classDef apiStyle fill:#ede7f6,stroke:#4527a0,stroke-width:2px
    classDef infraStyle fill:#fbe9e7,stroke:#bf360c,stroke-width:2px
    classDef monitorStyle fill:#eceff1,stroke:#263238,stroke-width:2px

    class Firewall,WAF,RateLimit perimeterStyle
    class TLS,HSTS transportStyle
    class SIWS,JWT,RefreshToken authStyle
    class RBAC,Middleware,OwnershipCheck authzStyle
    class XSSPrevention,SQLInjection,ZodValidation inputStyle
    class NonceProtection,TokenRotation,SessionRevocation sessionStyle
    class Encryption,Hashing,DataMasking dataStyle
    class SignatureVerif,OnChainValidation,ReplayProtection blockchainStyle
    class CORS,CSP,CSRF apiStyle
    class SecretManagement,DBAccess,AuditLog infraStyle
    class Intrusion,Alerts,IncidentResponse monitorStyle
