%% Bazari Platform - Data Flow Architecture
graph TB
    subgraph "Data Sources"
        UserInput["ğŸ‘¤ User Input<br/>(Forms, Actions)"]
        BlockchainEvents["â›“ï¸ Blockchain Events<br/>(Extrinsics, Blocks)"]
        ExternalAPIs["ğŸŒ External APIs<br/>(PIX, Email, SMS)"]
    end

    subgraph "Ingestion Layer"
        APIEndpoints["ğŸ”Œ API Endpoints<br/>(REST)"]
        WebSocketHandlers["ğŸ”Œ WebSocket Handlers<br/>(Real-time)"]
        EventListeners["ğŸ‘‚ Event Listeners<br/>(Blockchain)"]
    end

    subgraph "Processing Layer"
        BusinessLogic["âš™ï¸ Business Logic<br/>(Services)"]
        Validation["âœ… Validation<br/>(Zod schemas)"]
        Authorization["ğŸ” Authorization<br/>(Middleware)"]
    end

    subgraph "Storage Layer"
        direction LR
        PostgreSQLWrite[("ğŸ’¾ PostgreSQL<br/>Write")]
        IPFSWrite[("ğŸ“¦ IPFS<br/>Write")]
        ChainWrite[("â›“ï¸ Blockchain<br/>Write")]
    end

    subgraph "Cache Layer"
        RedisCache[("âš¡ Redis Cache<br/>(Hot data)")]
    end

    subgraph "Query Layer"
        PostgreSQLRead[("ğŸ“– PostgreSQL<br/>Read")]
        IPFSRead[("ğŸ“– IPFS<br/>Read")]
        ChainRead[("ğŸ“– Blockchain<br/>Read")]
    end

    subgraph "Aggregation Layer"
        DataAggregation["ğŸ“Š Data Aggregation<br/>(Analytics)"]
        SearchIndexing["ğŸ” Search Indexing<br/>(Full-text)"]
    end

    subgraph "Output Layer"
        APIResponses["ğŸ“¤ API Responses<br/>(JSON)"]
        WebSocketMessages["ğŸ“¤ WebSocket Messages<br/>(Real-time)"]
        Notifications["ğŸ”” Push Notifications"]
    end

    subgraph "Background Jobs"
        ReputationSync["â­ Reputation Sync<br/>(Every 60s)"]
        NonceCleanup["ğŸ§¹ Nonce Cleanup<br/>(Daily)"]
        IPFSPinning["ğŸ“Œ IPFS Pinning<br/>(Continuous)"]
    end

    %% Ingestion flow
    UserInput --> APIEndpoints
    UserInput --> WebSocketHandlers
    BlockchainEvents --> EventListeners
    ExternalAPIs --> APIEndpoints

    %% Processing flow
    APIEndpoints --> Authorization
    WebSocketHandlers --> Authorization
    Authorization --> Validation
    Validation --> BusinessLogic

    %% Storage flow
    BusinessLogic --> PostgreSQLWrite
    BusinessLogic --> IPFSWrite
    BusinessLogic --> ChainWrite
    BusinessLogic --> RedisCache

    %% Query flow
    BusinessLogic --> PostgreSQLRead
    BusinessLogic --> IPFSRead
    BusinessLogic --> ChainRead
    BusinessLogic --> RedisCache

    %% Aggregation flow
    PostgreSQLRead --> DataAggregation
    PostgreSQLRead --> SearchIndexing

    %% Output flow
    BusinessLogic --> APIResponses
    BusinessLogic --> WebSocketMessages
    BusinessLogic --> Notifications

    %% Background jobs
    ReputationSync --> PostgreSQLRead
    ReputationSync --> ChainRead
    ReputationSync --> ChainWrite
    NonceCleanup --> PostgreSQLWrite
    IPFSPinning --> IPFSRead

    %% Cache invalidation
    PostgreSQLWrite -.->|invalidate| RedisCache
    ChainWrite -.->|invalidate| RedisCache

    %% Styling
    classDef sourceStyle fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef ingestionStyle fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef processingStyle fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef storageStyle fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef cacheStyle fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    classDef queryStyle fill:#fff9c4,stroke:#f9a825,stroke-width:2px
    classDef aggregationStyle fill:#e0f2f1,stroke:#00796b,stroke-width:2px
    classDef outputStyle fill:#ede7f6,stroke:#512da8,stroke-width:2px
    classDef jobStyle fill:#fbe9e7,stroke:#d84315,stroke-width:2px

    class UserInput,BlockchainEvents,ExternalAPIs sourceStyle
    class APIEndpoints,WebSocketHandlers,EventListeners ingestionStyle
    class BusinessLogic,Validation,Authorization processingStyle
    class PostgreSQLWrite,IPFSWrite,ChainWrite storageStyle
    class RedisCache cacheStyle
    class PostgreSQLRead,IPFSRead,ChainRead queryStyle
    class DataAggregation,SearchIndexing aggregationStyle
    class APIResponses,WebSocketMessages,Notifications outputStyle
    class ReputationSync,NonceCleanup,IPFSPinning jobStyle
