{
  "module": {
    "id": "auth",
    "name": "Authentication & Authorization",
    "category": "core-transversal",
    "version": "1.0.0",
    "status": "production",
    "description": "Web3-native authentication via SIWS (Sign-In with Substrate), session management with JWT and refresh tokens"
  },
  "vision": {
    "statement": "Prover autenticação Web3-native segura, descentralizada e sem fricção para todos os módulos da plataforma Bazari",
    "principles": [
      "Web3-Native: Wallet as identity, no traditional passwords",
      "Stateless & Scalable: JWT-based authentication",
      "Security-First: Nonce expiration, token rotation, replay attack prevention",
      "Developer-Friendly: Simple middleware, auto-injected user context"
    ]
  },
  "entities": [
    {
      "name": "User",
      "table": "User",
      "type": "aggregate_root",
      "description": "Main authenticated user entity, identified by Substrate address",
      "fields": [
        {"name": "id", "type": "String", "pk": true, "description": "Internal UUID"},
        {"name": "address", "type": "String", "unique": true, "description": "Substrate address (SS58 format)"},
        {"name": "createdAt", "type": "DateTime", "default": "now()"},
        {"name": "updatedAt", "type": "DateTime", "autoUpdate": true}
      ],
      "relations": [
        {"name": "refreshTokens", "type": "1:N", "target": "RefreshToken"},
        {"name": "profile", "type": "1:1", "target": "Profile"},
        {"name": "sellerProfiles", "type": "1:N", "target": "SellerProfile"}
      ]
    },
    {
      "name": "AuthNonce",
      "table": "AuthNonce",
      "type": "entity",
      "lifecycle": "ephemeral",
      "description": "Cryptographic nonce for replay attack prevention in SIWS",
      "fields": [
        {"name": "id", "type": "String", "pk": true},
        {"name": "address", "type": "String", "indexed": true},
        {"name": "nonce", "type": "String", "unique": true},
        {"name": "domain", "type": "String"},
        {"name": "uri", "type": "String"},
        {"name": "genesis", "type": "String"},
        {"name": "issuedAt", "type": "DateTime"},
        {"name": "expiresAt", "type": "DateTime", "indexed": true},
        {"name": "usedAt", "type": "DateTime?", "indexed": true}
      ],
      "ttl": "5 minutes"
    },
    {
      "name": "RefreshToken",
      "table": "RefreshToken",
      "type": "entity",
      "description": "Long-lived token for renewing access tokens",
      "fields": [
        {"name": "id", "type": "String", "pk": true},
        {"name": "userId", "type": "String", "fk": "User.id", "indexed": true},
        {"name": "tokenHash", "type": "String", "unique": true, "description": "SHA-256 hash"},
        {"name": "createdAt", "type": "DateTime", "default": "now()"},
        {"name": "revokedAt", "type": "DateTime?", "indexed": true}
      ],
      "ttl": "30 days"
    }
  ],
  "valueObjects": [
    {
      "name": "AccessToken",
      "type": "JWT",
      "algorithm": "HS256",
      "expiration": "15 minutes",
      "payload": ["userId", "address", "iat", "exp"],
      "storage": "client-memory"
    },
    {
      "name": "SIWSMessage",
      "type": "plain_text",
      "format": "structured_message",
      "signing": "sr25519",
      "fields": ["domain", "address", "statement", "uri", "version", "chainId", "genesis", "nonce", "issuedAt"]
    }
  ],
  "apis": [
    {"method": "POST", "path": "/auth/nonce", "auth": false, "description": "Request authentication nonce"},
    {"method": "POST", "path": "/auth/verify", "auth": false, "description": "Verify signed message and authenticate"},
    {"method": "POST", "path": "/auth/refresh", "auth": false, "description": "Refresh access token"},
    {"method": "POST", "path": "/auth/logout", "auth": true, "description": "Logout current session"},
    {"method": "GET", "path": "/auth/me", "auth": true, "description": "Get current user info"}
  ],
  "useCases": [
    {
      "id": "UC-01",
      "name": "Web3 Authentication",
      "actors": ["User", "Wallet", "API"],
      "flow": "Request nonce → Sign message with wallet → Verify signature → Issue tokens"
    },
    {
      "id": "UC-02",
      "name": "Token Refresh",
      "actors": ["Client", "API"],
      "flow": "Access token expires → Client sends refresh token → Server validates → Issue new access token"
    },
    {
      "id": "UC-03",
      "name": "Session Logout",
      "actors": ["User", "API"],
      "flow": "User clicks logout → Client sends logout request → Server revokes refresh token"
    }
  ],
  "dependencies": {
    "internal": [],
    "external": ["@polkadot/util-crypto", "jsonwebtoken"]
  },
  "security": {
    "authentication": "SIWS (Sign-In with Substrate)",
    "tokens": "JWT (access) + SHA-256 hashed refresh tokens",
    "transport": "HTTPS only",
    "cookies": "HttpOnly, Secure, SameSite=Strict",
    "protections": ["Nonce expiration", "Token rotation", "Replay attack prevention", "CSRF protection"]
  },
  "metrics": {
    "key_metrics": ["Daily active users", "Authentication success rate", "Token refresh rate", "Session duration"]
  }
}
