// path: apps/api/prisma/schema.prisma

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
  extensions        = [pg_trgm]
}

model MediaAsset {
  id          String   @id @default(cuid())
  url         String // FS: /uploads/abc.png; S3: URL p√∫blica
  mime        String
  size        Int
  contentHash String
  ownerType   String?
  ownerId     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([ownerType, ownerId])
  @@index([contentHash])
}

model Category {
  id          String   @id
  slug        String   @unique
  parentId    String?
  kind        String // "product" | "service"
  level       Int // 1..4
  namePt      String
  nameEn      String
  nameEs      String
  pathSlugs   String[]
  pathNamesPt String[]
  pathNamesEn String[]
  pathNamesEs String[]
  active      Boolean  @default(true)
  sort        Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products Product[]
  services ServiceOffering[]

  @@index([slug])
  @@index([kind, level])
  @@index([parentId])
  @@index([pathSlugs], type: Gin)
}

model CategorySpec {
  id           String   @id @default(cuid())
  categoryId   String
  version      String // sem√¢ntico, ex: 1.0.0
  inheritsFrom String? // opcional (outro categoryId)
  jsonSchema   Json
  uiSchema     Json
  indexHints   String[]
  createdAt    DateTime @default(now())

  @@unique([categoryId, version])
  @@index([categoryId])
}

model Product {
  id                    String        @id @default(uuid())
  daoId                 String
  title                 String
  description           String?
  priceBzr              Decimal       @db.Decimal(20, 12)
  categoryId            String
  categoryPath          String[]
  attributes            Json
  attributesSpecVersion String
  sellerUserId          String?
  sellerStoreId         String?
  onChainStoreId        BigInt?       @db.BigInt
  status                ProductStatus @default(PUBLISHED)
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  // === Shipping & Delivery (PROPOSAL-000) ===
  estimatedDeliveryDays Int?    @default(7) // Prazo estimado em dias √∫teis (legacy, usar shippingOptions)
  shippingMethod        String? // SEDEX | PAC | ... (legacy, usar shippingOptions)
  weight                Float?  @db.Real // Peso em kg
  dimensions            Json? // { length, width, height } em cm

  // === Multiple Shipping Options (PROPOSAL-002) ===
  shippingOptions ProductShippingOption[]

  category    Category       @relation(fields: [categoryId], references: [id])
  sellerStore SellerProfile? @relation(fields: [sellerStoreId], references: [id])

  @@index([daoId])
  @@index([categoryId])
  @@index([categoryPath], type: Gin)
  @@index([title])
  @@index([description])
  @@index([attributes], type: Gin)
  @@index([priceBzr])
  @@index([createdAt])
  @@index([sellerUserId])
  @@index([status])
  @@index([sellerStoreId])
  @@index([onChainStoreId])
  @@index([shippingMethod])
}

// === PROPOSAL-002: Multiple Shipping Options per Product ===
model ProductShippingOption {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // M√©todo de envio
  method String // SEDEX | PAC | TRANSPORTADORA | MINI_ENVIOS | RETIRADA | INTERNACIONAL | OUTRO
  label  String? // Nome customizado (ex: "Entrega Expressa")

  // Pre√ßo do frete
  pricingType  String   @default("FIXED") // FIXED | FREE | FREE_ABOVE | TO_ARRANGE
  priceBzr     Decimal? @db.Decimal(20, 12) // Valor fixo (quando FIXED ou FREE_ABOVE)
  freeAboveBzr Decimal? @db.Decimal(20, 12) // Gr√°tis acima de X (quando FREE_ABOVE)

  // Prazo
  estimatedDeliveryDays Int @default(7)

  // Retirada em loja (quando method = RETIRADA)
  pickupAddressType String? @default("STORE") // STORE | CUSTOM
  pickupAddress     Json? // Se CUSTOM: { street, number, city, state, zipCode, instructions? }

  // Ordena√ß√£o e status
  isDefault Boolean @default(false) // Op√ß√£o padr√£o selecionada no checkout
  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId, isActive])
  @@index([productId, sortOrder])
}

model ServiceOffering {
  id                    String   @id @default(uuid())
  daoId                 String
  title                 String
  description           String?
  basePriceBzr          Decimal? @db.Decimal(20, 12)
  categoryId            String
  categoryPath          String[]
  attributes            Json
  attributesSpecVersion String
  sellerStoreId         String?
  onChainStoreId        BigInt?  @db.BigInt
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  category    Category       @relation(fields: [categoryId], references: [id])
  sellerStore SellerProfile? @relation(fields: [sellerStoreId], references: [id])

  @@index([daoId])
  @@index([categoryId])
  @@index([categoryPath], type: Gin)
  @@index([title])
  @@index([description])
  @@index([attributes], type: Gin)
  @@index([basePriceBzr])
  @@index([createdAt])
  @@index([sellerStoreId])
  @@index([onChainStoreId])
}

model AuditLog {
  id        String   @id @default(cuid())
  entity    String
  entityId  String
  actor     String?
  action    String
  diff      Json?
  ip        String?
  ua        String?
  createdAt DateTime @default(now())

  @@index([entity, entityId])
  @@index([createdAt])
}

model User {
  id        String   @id @default(uuid())
  address   String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // TODO: Integrar com sistema de governance/conselho para aprova√ß√£o de apps
  // Por enquanto usando role simples para admins
  role String @default("USER") // "USER" | "ADMIN" | "MODERATOR"

  refreshTokens RefreshToken[]

  // Perfis (1:1) e Lojas (1:N)
  profile        Profile?
  sellerProfiles SellerProfile[]

  // Relacionamentos DAO (owner)
  daosOwned Dao[]

  // Notifica√ß√µes
  notifications Notification[]

  // Intera√ß√µes (para feed algor√≠tmico)
  interactions UserInteraction[]

  // Achievements
  achievements UserAchievement[]

  // Quests
  quests UserQuest[]

  // Reports
  reportsCreated  ContentReport[] @relation("reporter")
  reportsReviewed ContentReport[] @relation("reviewer")

  // Block & Mute
  blocking  UserBlock[] @relation("blocker")
  blockedBy UserBlock[] @relation("blocked")
  muting    UserMute[]  @relation("muter")
  mutedBy   UserMute[]  @relation("muted")

  // Social Auth (Fase 1)
  socialAccount SocialAccount?
  managedWallet ManagedWallet?

  // OAuth Multi-Conta (Fase 2)
  socialBackups SocialBackup[]

  // VR Integration
  vrTokens VRToken[]

  // BazariOS Developer Portal
  developerApps ThirdPartyApp[] @relation("DeveloperApps")
  appReviews    AppReview[]     @relation("AppReviews")
  appPurchases  AppPurchase[]   @relation("UserAppPurchases")

  // Bazari Pay
  payContractsAsPayer      PayContract[]              @relation("PayContractPayer")
  payContractsAsReceiver   PayContract[]              @relation("PayContractReceiver")
  payContractStatusChanges PayContractStatusHistory[] @relation("PayContractStatusChangedBy")
  payAdjustmentsCreated    PayAdjustment[]            @relation("PayAdjustmentCreatedBy")
  payAdjustmentsApproved   PayAdjustment[]            @relation("PayAdjustmentApprovedBy")

  // Bazari Pay Enterprise (PROMPT-06)
  payBatchImportsUploaded PayBatchImport[] @relation("PayBatchImportUploadedBy")
  payApiKeysCreated       PayApiKey[]      @relation("PayApiKeyCreatedBy")
  payWebhooksCreated      PayWebhook[]     @relation("PayWebhookCreatedBy")
}

model SocialAccount {
  id         String   @id @default(uuid())
  userId     String   @unique
  provider   String // "google" | "email" (futuro)
  providerId String // Google sub ou email hash
  email      String?
  name       String? // Nome do usu√°rio do Google
  picture    String? // Avatar URL do Google
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([email])
  @@index([providerId])
}

model ManagedWallet {
  id                String   @id @default(uuid())
  userId            String   @unique
  encryptedMnemonic String // Mnemonic criptografado com ENCRYPTION_KEY
  iv                String // Initialization vector para AES
  salt              String // Salt usado na deriva√ß√£o de chave
  authTag           String // Auth tag para GCM
  address           String // Address SR25519 derivado
  sentToClient      Boolean  @default(false) // Flag: mnemonic j√° foi enviado para cliente?
  isPinSetup        Boolean  @default(false) // Flag: PIN foi configurado pelo usu√°rio?
  legacyServerSeed  Boolean  @default(false) // Flag: wallet criado com gera√ß√£o server-side (legacy)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([address])
}

// OAuth Multi-Conta: M√∫ltiplos backups E2EE por usu√°rio OAuth
model SocialBackup {
  id     String @id @default(uuid())
  userId String // M√∫ltiplos backups por user OAuth (n√£o unique!)

  // Identifica√ß√£o da conta
  accountName  String // "Conta Principal", "Loja Online", etc
  accountIndex Int // 1, 2, 3... (auto-incrementado por userId)
  address      String @unique // Address SR25519 √∫nico

  // E2EE Backup (cifrado client-side com PIN do usu√°rio)
  encryptedMnemonic String // Blob opaco cifrado
  iv                String // Initialization vector
  salt              String // Salt para PBKDF2
  authTag           String // GCM auth tag
  iterations        Int    @default(150000) // PBKDF2 iterations

  // Metadata
  createdAt         DateTime @default(now())
  lastUsedAt        DateTime @default(now()) // Atualizado a cada restore
  deviceFingerprint String? // Opcional: identificar device que criou

  // Soft delete
  isActive Boolean @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, accountIndex]) // Uma conta por √≠ndice por usu√°rio
  @@index([userId, isActive]) // Lista contas ativas
  @@index([address])
  @@index([lastUsedAt])
}

model AuthNonce {
  id        String    @id @default(uuid())
  address   String
  nonce     String    @unique
  domain    String
  uri       String
  genesis   String
  issuedAt  DateTime
  expiresAt DateTime
  usedAt    DateTime?

  @@index([address])
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String
  tokenHash String    @unique
  createdAt DateTime  @default(now())
  revokedAt DateTime?
  user      User      @relation(fields: [userId], references: [id])

  @@index([userId])
}

enum OrderStatus {
  CREATED
  PENDING
  PENDING_BLOCKCHAIN // Order criada no DB, aguardando sync on-chain
  BLOCKCHAIN_FAILED // Falha ao criar on-chain (retry pendente)
  ESCROWED
  SHIPPED
  RELEASED
  REFUNDED
  CANCELLED
  TIMEOUT
}

enum PaymentIntentStatus {
  PENDING
  FUNDS_IN
  RELEASED
  REFUNDED
  TIMEOUT
  CANCELLED
}

// Publica√ß√£o/status de produtos
enum ProductStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// Status de posts
enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum NotificationType {
  FOLLOW
  LIKE
  REPOST
  COMMENT
  MENTION
  BADGE
  REPUTATION
  ACHIEVEMENT_UNLOCKED
  GROUP_INVITE
  GROUP_JOIN_REQUEST
  // App Store notifications
  APP_APPROVED
  APP_REJECTED
  APP_UNPUBLISHED
}

// === PROPOSAL-003: Multi-Store Checkout Session ===
model CheckoutSession {
  id        String                @id @default(cuid())
  buyerAddr String
  status    CheckoutSessionStatus @default(PENDING)
  orders    Order[]               @relation("CheckoutSessionOrders")

  // Batch transaction info
  batchTxHash String?
  totalBzr    Decimal @db.Decimal(30, 0)

  createdAt DateTime  @default(now())
  expiresAt DateTime
  paidAt    DateTime?

  @@index([buyerAddr, status])
  @@index([batchTxHash])
  @@index([expiresAt])
}

enum CheckoutSessionStatus {
  PENDING
  PAID
  FAILED
  EXPIRED
}

model Order {
  id               String      @id @default(uuid())
  buyerAddr        String
  sellerAddr       String
  sellerId         String // DAO ID do vendedor
  sellerStoreId    String?
  subtotalBzr      Decimal     @db.Decimal(30, 0) // subtotal em planck
  shippingBzr      Decimal     @db.Decimal(30, 0) // frete em planck
  totalBzr         Decimal     @db.Decimal(30, 0) // total em planck
  status           OrderStatus @default(CREATED)
  shippingAddress  Json? // endere√ßo de entrega
  shippingOptionId String? // ID da op√ß√£o de frete
  notes            String? // observa√ß√µes do pedido
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  // === Shipping & Delivery (PROPOSAL-000) ===
  estimatedDeliveryDays Int?      @default(7) // Prazo estimado (copiado do produto ou informado)
  shippingMethod        String? // M√©todo de envio selecionado
  shippedAt             DateTime? // Quando foi marcado como enviado
  trackingCode          String? // C√≥digo de rastreamento

  // === Delivery-Aware Escrow (PROPOSAL-001) ===
  autoReleaseBlocks     Int       @default(100800) // Blocos para auto-release (default 7 dias = 100,800)
  estimatedDeliveryDate DateTime? // Data estimada de entrega calculada

  // === PROPOSAL-003: Multi-Store Checkout ===
  checkoutSessionId String?
  checkoutSession   CheckoutSession? @relation("CheckoutSessionOrders", fields: [checkoutSessionId], references: [id])

  // ‚úÖ NEW: Blockchain reference (bazari-commerce pallet)
  blockchainOrderId BigInt?   @db.BigInt // On-chain OrderId (u64)
  blockchainTxHash  String? // Transaction hash when created on-chain
  onChainStatus     String? // Cache of on-chain status (PENDING, CONFIRMED, etc)
  lastSyncedAt      DateTime? // Last time synced with blockchain
  blockchainRetries Int       @default(0) // Number of retry attempts for blockchain sync
  blockchainError   String? // Last error message from blockchain sync attempt

  items          OrderItem[]
  paymentIntents PaymentIntent[]
  escrowLogs     EscrowLog[]

  // === Delivery Relation ===
  deliveryRequest DeliveryRequest?

  @@index([buyerAddr])
  @@index([sellerAddr])
  @@index([sellerId])
  @@index([sellerStoreId])
  @@index([status])
  @@index([createdAt])
  @@index([blockchainOrderId])
  @@index([shippedAt])
  @@index([checkoutSessionId])
}

model OrderItem {
  id                   String   @id @default(cuid())
  orderId              String
  listingId            String // ID do produto/servi√ßo
  kind                 String // 'product' | 'service'
  qty                  Int
  unitPriceBzrSnapshot Decimal  @db.Decimal(30, 0) // pre√ßo unit√°rio em planck no momento do pedido
  titleSnapshot        String // t√≠tulo no momento do pedido
  lineTotalBzr         Decimal  @db.Decimal(30, 0) // qty * unitPrice em planck
  createdAt            DateTime @default(now())

  // === PROPOSAL-002: Snapshot da op√ß√£o de envio selecionada ===
  shippingOptionId              String? // ID da ProductShippingOption selecionada
  shippingMethodSnapshot        String? // M√©todo no momento do pedido
  shippingPriceBzrSnapshot      Decimal? @db.Decimal(30, 0) // Pre√ßo do frete em planck
  estimatedDeliveryDaysSnapshot Int? // Prazo no momento do pedido

  order Order @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([listingId])
  @@index([kind])
}

model PaymentIntent {
  id            String              @id @default(cuid())
  orderId       String
  amountBzr     Decimal             @db.Decimal(30, 0) // planck
  escrowAddress String
  status        PaymentIntentStatus @default(PENDING)
  txHashIn      String? // hash do dep√≥sito
  txHashRelease String?
  txHashRefund  String?
  createdAt     DateTime            @default(now())

  // ‚úÖ NEW: Blockchain reference (bazari-escrow pallet)
  escrowId BigInt? @db.BigInt // On-chain escrow ID (order_id used as key)
  txHash   String? // Real transaction hash from bazari-escrow (replaces MOCK)

  order Order @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([status])
  @@index([createdAt])
  @@index([txHash])
}

model EscrowLog {
  id          String   @id @default(cuid())
  orderId     String
  kind        String // 'RELEASE_REQUEST' | 'REFUND_REQUEST' | 'TIMEOUT' | ...
  payloadJson Json
  createdAt   DateTime @default(now())

  order Order @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([kind])
  @@index([createdAt])
}

/// --- Social / Profiles ---

model Profile {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id])
  handle         String   @unique
  displayName    String
  bio            String?  @db.Text
  avatarUrl      String?
  bannerUrl      String?
  externalLinks  Json?
  followersCount Int      @default(0)
  followingCount Int      @default(0)
  postsCount     Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // === NFT/Identidade Soberana ===
  onChainProfileId BigInt?   @unique @db.BigInt
  reputationScore  Int       @default(0)
  reputationTier   String    @default("bronze")
  isVerified       Boolean   @default(false)
  lastChainSync    DateTime?

  // === Monetiza√ß√£o (MOCK) ===
  cashbackBalance String @default("0") // BZR cashback balance (MOCK)

  // === Chat E2EE ===
  chatPublicKey String? // Curve25519 public key (base64) for E2EE chat

  // === Online Status ===
  lastSeenAt       DateTime?
  showOnlineStatus Boolean   @default(true)

  // Relations
  posts                 Post[]
  postComments          PostComment[]
  postReposts           PostRepost[]
  postReactions         PostReaction[]
  commentLikes          PostCommentLike[]
  followers             Follow[]                 @relation("follows_following")
  following             Follow[]                 @relation("follows_follower")
  badges                ProfileBadge[]
  reputationEvents      ProfileReputationEvent[]
  handleHistory         HandleHistory[]
  notificationsAsActor  Notification[]           @relation("NotificationActor")
  affiliates            ChatStoreAffiliate[]
  affiliateMarketplaces AffiliateMarketplace[]   @relation("AffiliateMarketplaces")

  // === Delivery Relations ===
  deliveryProfile             DeliveryProfile?
  deliveryRequestsAsDeliverer DeliveryRequest[]      @relation("DeliveryPerson")
  storePartnerships           StoreDeliveryPartner[] @relation("StoreDeliveryPartner")

  // === Rewards Relations (Blockchain Gamification) ===
  missionProgress UserMissionProgress[]
  cashbackGrants  CashbackGrant[]

  // === Developer Apps (SDK External Apps) ===
  developerApps DeveloperApp[] @relation("DeveloperApps")

  // === Chat Reactions ===
  chatMessageReactions ChatMessageReaction[]

  // === Stories ===
  stories      Story[]
  storyViews   StoryView[]
  storyReplies StoryReply[]

  // === Calls ===
  callsAsCaller Call[] @relation("CallsCaller")
  callsAsCallee Call[] @relation("CallsCallee")

  // === Web Push ===
  pushSubscriptions PushSubscription[]

  // === Bazari Work Professional Profile ===
  professionalProfile ProfessionalProfile?

  // === Bazari Work Job Postings (PROMPT-03) ===
  jobPostingsCreated JobPosting[]     @relation("JobPostingCreatedBy")
  jobApplications    JobApplication[] @relation("JobApplicationApplicant")

  // === Bazari Work Proposals (PROMPT-04) ===
  proposalsSent     WorkProposal[] @relation("WorkProposalSender")
  proposalsReceived WorkProposal[] @relation("WorkProposalReceiver")

  // === Bazari Work Agreements (PROMPT-05) ===
  workAgreements         WorkAgreement[]          @relation("WorkAgreementWorker")
  agreementStatusChanges AgreementStatusHistory[] @relation("AgreementStatusChangedBy")

  // === Bazari Work Evaluations (PROMPT-07) ===
  evaluationsGiven    WorkEvaluation[] @relation("WorkEvaluationAuthor")
  evaluationsReceived WorkEvaluation[] @relation("WorkEvaluationTarget")

  @@index([onChainProfileId])
  @@index([reputationScore])
  @@index([reputationTier])
}

// === BAZARI WORK: Professional Profile Extension ===
enum ProfessionalStatus {
  AVAILABLE
  NOT_AVAILABLE
  INVISIBLE
}

enum WorkPreference {
  REMOTE
  ON_SITE
  HYBRID
}

model ProfessionalProfile {
  id        String  @id @default(uuid())
  profileId String  @unique
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  // Dados profissionais
  professionalArea   String?
  skills             String[]
  experience         String?        @db.Text
  hourlyRate         Decimal?       @db.Decimal(10, 2)
  hourlyRateCurrency String         @default("BRL")
  workPreference     WorkPreference @default(REMOTE)

  // Visibilidade
  status         ProfessionalStatus @default(AVAILABLE)
  showHourlyRate Boolean            @default(false)

  // Avalia√ß√µes (PROMPT-07)
  averageRating      Float?
  totalEvaluations   Int    @default(0)
  completedContracts Int    @default(0)

  // Metadados
  activatedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status])
  @@index([professionalArea])
  @@index([skills], type: Gin)
  @@index([workPreference])
  @@index([averageRating])
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower  Profile @relation("follows_follower", fields: [followerId], references: [id])
  following Profile @relation("follows_following", fields: [followingId], references: [id])

  @@unique([followerId, followingId])
  @@index([followingId])
}

model SellerProfile {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id])
  shopName          String
  shopSlug          String   @unique
  about             String?  @db.Text
  ratingAvg         Float    @default(0)
  ratingCount       Int      @default(0)
  policies          Json?
  avatarUrl         String?
  bannerUrl         String?
  isDefault         Boolean  @default(false)
  onChainStoreId    BigInt?  @db.BigInt
  ownerAddress      String?
  operatorAddresses String[] @default([])
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // === Campos de Sincroniza√ß√£o On-Chain ===
  syncStatus      String?   @default("pending") // 'pending' | 'syncing' | 'synced' | 'error'
  version         Int?      @default(0) // vers√£o incremental da loja on-chain
  lastSyncBlock   BigInt?   @db.BigInt // √∫ltimo bloco onde foi feita sincroniza√ß√£o
  lastPublishedAt DateTime? // timestamp da √∫ltima publica√ß√£o on-chain

  // === Address for Pickup ===
  pickupAddress Json? // { street, number, complement?, city, state, zipCode, lat?, lng?, instructions? }

  // Relations
  products        Product[]
  services        ServiceOffering[]
  publishHistory  StorePublishHistory[]
  land            Land? // VR: Rela√ß√£o 1:1 com terreno virtual
  pluginInstances PluginInstance[] // Plugins instalados na loja

  // === Bazari Work Job Postings (PROMPT-03) ===
  jobPostings JobPosting[]

  // === Bazari Work Proposals (PROMPT-04) ===
  workProposals WorkProposal[]

  // === Bazari Work Agreements (PROMPT-05) ===
  workAgreements WorkAgreement[]

  // === Bazari Pay (PROMPT-01) ===
  payContracts PayContract[] @relation("PayContractPayerCompany")

  // === Bazari Pay Enterprise (PROMPT-06) ===
  payBatchImports PayBatchImport[] @relation("PayBatchImportCompany")
  payApiKeys      PayApiKey[]      @relation("PayApiKeyCompany")
  payWebhooks     PayWebhook[]     @relation("PayWebhookCompany")

  @@index([userId])
  @@index([onChainStoreId])
  @@index([ownerAddress])
  @@index([operatorAddresses], type: Gin)
  @@index([syncStatus])
}

model Post {
  id        String     @id @default(cuid())
  authorId  String
  author    Profile    @relation(fields: [authorId], references: [id])
  kind      String // 'text' | 'image' | 'link' (MVP: text)
  content   String     @db.Text
  media     Json?
  status    PostStatus @default(PUBLISHED)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  likes     PostLike[]
  reposts   PostRepost[]
  reactions PostReaction[]
  comments  PostComment[]

  @@index([authorId, createdAt])
  @@index([status])
}

model PostLike {
  id        String   @id @default(cuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  profileId String
  createdAt DateTime @default(now())

  @@unique([postId, profileId])
  @@index([postId])
  @@index([profileId])
}

model PostRepost {
  id        String   @id @default(cuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  profileId String
  profile   Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([postId, profileId])
  @@index([postId])
  @@index([profileId])
}

model PostReaction {
  id        String   @id @default(cuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  profileId String
  profile   Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  reaction  String // love, laugh, wow, sad, angry
  createdAt DateTime @default(now())

  @@unique([postId, profileId])
  @@index([postId])
  @@index([profileId])
  @@index([postId, reaction])
}

model PostComment {
  id        String   @id @default(cuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId  String
  author    Profile  @relation(fields: [authorId], references: [id], onDelete: Cascade)
  content   String   @db.Text
  parentId  String? // Para respostas aninhadas
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parent  PostComment?      @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies PostComment[]     @relation("CommentReplies")
  likes   PostCommentLike[]

  @@index([postId, createdAt])
  @@index([authorId])
  @@index([parentId])
}

model PostCommentLike {
  id        String      @id @default(cuid())
  commentId String
  comment   PostComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  profileId String
  profile   Profile     @relation(fields: [profileId], references: [id], onDelete: Cascade)
  createdAt DateTime    @default(now())

  @@unique([commentId, profileId])
  @@index([commentId])
  @@index([profileId])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  actorId   String?
  actor     Profile?         @relation("NotificationActor", fields: [actorId], references: [id], onDelete: Cascade)
  targetId  String? // ID do post, comment, badge, etc
  metadata  Json? // Dados adicionais espec√≠ficos do tipo
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([userId, read, createdAt])
  @@index([createdAt])
}

model ProfileBadge {
  id           String    @id @default(cuid())
  profileId    String
  profile      Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  code         String
  label        Json // {pt, en, es}
  issuedBy     String // marketplace, dao, system, etc
  issuedAt     DateTime
  blockNumber  BigInt    @db.BigInt
  revokedAt    DateTime?
  revokeReason String?

  @@unique([profileId, code])
  @@index([profileId])
  @@index([code])
  @@index([issuedAt])
}

model ProfileReputationEvent {
  id          String   @id @default(cuid())
  profileId   String
  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  eventCode   String // ORDER_COMPLETED, DELIVERY_DONE, etc
  delta       Int
  newTotal    Int
  reason      String?
  emittedBy   String // marketplace, delivery, social, etc
  blockNumber BigInt   @db.BigInt
  extrinsicId String?
  createdAt   DateTime @default(now())

  @@index([profileId, createdAt])
  @@index([eventCode])
  @@index([blockNumber])
}

model HandleHistory {
  id          String   @id @default(cuid())
  profileId   String
  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  oldHandle   String?
  newHandle   String
  changedAt   DateTime
  blockNumber BigInt   @db.BigInt

  @@index([profileId, changedAt])
  @@index([newHandle])
}

model Dao {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  ownerUserId String?
  owner       User?   @relation(fields: [ownerUserId], references: [id])

  @@index([ownerUserId])
}

model SubDao {
  id          String @id @default(cuid())
  daoId       String
  name        String
  slug        String @unique
  ownerUserId String // User.id (dono/admin)

  @@index([ownerUserId])
}

model ProfileSubDao {
  id        String   @id @default(cuid())
  profileId String
  subDaoId  String
  role      String // 'owner' | 'admin' | 'member'
  createdAt DateTime @default(now())

  @@unique([profileId, subDaoId])
}

/// --- P2P (Offers / Orders) ---

enum P2POfferSide {
  BUY_BZR
  SELL_BZR
}

enum P2POfferStatus {
  ACTIVE
  PAUSED
  ARCHIVED
}

enum P2POrderStatus {
  DRAFT
  AWAITING_ESCROW
  AWAITING_FIAT_PAYMENT
  AWAITING_CONFIRMATION
  RELEASED
  EXPIRED
  CANCELLED
  DISPUTE_OPEN
  DISPUTE_RESOLVED_BUYER
  DISPUTE_RESOLVED_SELLER
}

enum P2PPaymentMethod {
  PIX
}

// FASE 5: Asset types for P2P trading
enum P2PAssetType {
  BZR
  ZARI
}

model P2PPaymentProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  pixKey      String?
  bankName    String?
  accountName String?
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
}

model P2POffer {
  id      String       @id @default(cuid())
  ownerId String
  side    P2POfferSide

  // FASE 5: Asset being traded
  assetType P2PAssetType @default(BZR)
  assetId   String? // '1' for ZARI, null for BZR

  // FASE 5: Phase info (only for ZARI)
  phase      String? // '2A' | '2B' | '3' | null
  phasePrice Decimal? @db.Decimal(18, 12) // 0.25 | 0.35 | 0.50 (in BZR)

  // Pricing (now generic)
  priceBRLPerBZR  Decimal  @db.Decimal(18, 2) // Deprecated, use priceBRLPerUnit
  priceBRLPerUnit Decimal? @db.Decimal(18, 2) // R$/BZR or R$/ZARI
  minBRL          Decimal  @db.Decimal(18, 2)
  maxBRL          Decimal  @db.Decimal(18, 2)

  method    P2PPaymentMethod
  autoReply String?
  status    P2POfferStatus   @default(ACTIVE)

  // FASE 5: Expanded stats
  stats Json? // { totalSold, totalVolume, phaseSupplyLeft }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId, status, side])
  @@index([ownerId, status, side, assetType])
  @@index([assetType, phase, status])
}

model P2POrder {
  id      String       @id @default(cuid())
  offerId String
  makerId String
  takerId String
  side    P2POfferSide

  // FASE 5: Asset info
  assetType P2PAssetType @default(BZR)
  assetId   String? // '1' for ZARI
  phase     String? // '2A', '2B', '3'

  // Pricing
  priceBRLPerBZR  Decimal  @db.Decimal(18, 2) // Deprecated, use priceBRLPerUnit
  priceBRLPerUnit Decimal? @db.Decimal(18, 2)
  amountBZR       Decimal  @db.Decimal(38, 18) // Deprecated, use amountAsset
  amountAsset     Decimal? @db.Decimal(38, 18) // BZR or ZARI
  amountBRL       Decimal  @db.Decimal(18, 2)

  method P2PPaymentMethod
  status P2POrderStatus   @default(DRAFT)

  // Escrow on-chain
  escrowTxHash   String?
  escrowAt       DateTime?
  releasedTxHash String?
  releasedAt     DateTime?

  // PIX proof
  pixKeySnapshot  String?
  payerDeclaredAt DateTime?
  proofUrls       Json?

  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([makerId, takerId, status])
  @@index([makerId, takerId, status, assetType])
  @@index([offerId])
  @@index([assetType, phase])
}

model P2PMessage {
  id        String   @id @default(cuid())
  orderId   String
  senderId  String
  body      String   @db.Text
  kind      String
  createdAt DateTime @default(now())

  @@index([orderId, createdAt])
}

model P2PDispute {
  id         String   @id @default(cuid())
  orderId    String   @unique
  openedById String
  reason     String
  evidence   Json?
  status     String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model P2PReview {
  id        String   @id @default(cuid())
  orderId   String   @unique
  raterId   String
  rateeId   String
  stars     Int
  comment   String?
  createdAt DateTime @default(now())
}

// FASE 5: ZARI Phase Configuration
model ZARIPhaseConfig {
  id          String   @id @default(cuid())
  phase       String   @unique // '2A', '2B', '3'
  priceBZR    Decimal  @db.Decimal(18, 12) // 0.25, 0.35, 0.50
  supplyLimit BigInt // 2_100_000 * 10^12 (decimals)
  startBlock  BigInt? // Block number when phase started
  endBlock    BigInt? // Block number when phase ended
  active      Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([phase, active])
}

/// --- Store Publishing History ---

model StorePublishHistory {
  id              String        @id @default(cuid())
  sellerProfileId String
  sellerProfile   SellerProfile @relation(fields: [sellerProfileId], references: [id], onDelete: Cascade)
  version         Int // vers√£o incremental
  blockNumber     BigInt        @db.BigInt // bloco em que foi publicado
  extrinsicHash   String? // hash da extrinsic do publish_store
  publishedAt     DateTime      @default(now())

  @@index([sellerProfileId, version])
  @@index([blockNumber])
  @@index([publishedAt])
}

// User Interactions for Feed Algorithm
model UserInteraction {
  id              String   @id @default(cuid())
  userId          String
  targetType      String // POST, PROFILE, PRODUCT
  targetId        String
  interactionType String // VIEW, LIKE, COMMENT, SHARE
  weight          Float    @default(1.0)
  createdAt       DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([targetType, targetId])
  @@index([userId, targetType])
}

model TrendingTopic {
  id         String   @id @default(cuid())
  tag        String   @unique
  count      Int      @default(0)
  score      Float    @default(0)
  growthRate Float? // Taxa de crescimento vs per√≠odo anterior
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([score(sort: Desc), updatedAt])
  @@index([updatedAt])
}

model Achievement {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  description String   @db.Text
  category    String // SOCIAL, ENGAGEMENT, CONTENT, STREAK
  tier        Int      @default(1) // 1-5 (Bronze to Diamond)
  requirement Json // { type: "POST_COUNT", value: 1 }
  icon        String? // Emoji ou URL
  createdAt   DateTime @default(now())

  userAchievements UserAchievement[]

  @@index([category, tier])
}

model UserAchievement {
  id            String    @id @default(cuid())
  userId        String
  achievementId String
  progress      Int       @default(0) // Progresso atual
  unlockedAt    DateTime? // null = ainda bloqueado
  createdAt     DateTime  @default(now())

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId, unlockedAt])
  @@index([achievementId])
}

model Quest {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  description String   @db.Text
  type        String // POST, LIKE, COMMENT, FOLLOW
  target      Int // Quantidade necess√°ria
  reward      Int // Pontos de reward
  icon        String?
  createdAt   DateTime @default(now())

  userQuests UserQuest[]

  @@index([type])
}

model UserQuest {
  id          String    @id @default(cuid())
  userId      String
  questId     String
  progress    Int       @default(0)
  completedAt DateTime? // null = n√£o completado
  claimedAt   DateTime? // null = reward n√£o reivindicado
  date        String // YYYY-MM-DD para track di√°rio
  createdAt   DateTime  @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  quest Quest @relation(fields: [questId], references: [id], onDelete: Cascade)

  @@unique([userId, questId, date])
  @@index([userId, date])
  @@index([questId, date])
}

enum ReportReason {
  SPAM
  HARASSMENT
  INAPPROPRIATE
  MISINFORMATION
  VIOLENCE
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
  DISMISSED
}

model ContentReport {
  id          String       @id @default(cuid())
  reporterId  String
  contentType String // POST, COMMENT, PROFILE
  contentId   String
  reason      ReportReason
  details     String?      @db.Text
  status      ReportStatus @default(PENDING)
  reviewedBy  String?
  reviewedAt  DateTime?
  createdAt   DateTime     @default(now())

  reporter User  @relation("reporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reviewer User? @relation("reviewer", fields: [reviewedBy], references: [id])

  @@index([status, createdAt])
  @@index([contentType, contentId])
  @@index([reporterId])
}

model UserBlock {
  id            String   @id @default(cuid())
  userId        String
  blockedUserId String
  createdAt     DateTime @default(now())

  user        User @relation("blocker", fields: [userId], references: [id], onDelete: Cascade)
  blockedUser User @relation("blocked", fields: [blockedUserId], references: [id], onDelete: Cascade)

  @@unique([userId, blockedUserId])
  @@index([userId])
  @@index([blockedUserId])
}

// Profile-based blocking for chat
model ChatBlock {
  id             String   @id @default(cuid())
  blockerProfile String // Profile ID that is blocking
  blockedProfile String // Profile ID that is blocked
  reason         String? // Optional reason
  createdAt      DateTime @default(now())

  @@unique([blockerProfile, blockedProfile])
  @@index([blockerProfile])
  @@index([blockedProfile])
}

model UserMute {
  id          String   @id @default(cuid())
  userId      String
  mutedUserId String
  createdAt   DateTime @default(now())

  user      User @relation("muter", fields: [userId], references: [id], onDelete: Cascade)
  mutedUser User @relation("muted", fields: [mutedUserId], references: [id], onDelete: Cascade)

  @@unique([userId, mutedUserId])
  @@index([userId])
  @@index([mutedUserId])
}

// ===========================
// BazChat Models (FASE 0)
// ===========================

model ChatThread {
  id            String   @id @default(uuid())
  kind          String // dm | store | order | group
  participants  String[] // profileIds
  orderId       String?
  groupId       String?
  lastMessageAt BigInt
  metadata      Json?
  createdAt     BigInt
  updatedAt     BigInt

  messages    ChatMessage[]
  proposals   ChatProposal[]
  preferences ChatThreadPreference[]
  calls       Call[]

  @@index([participants])
  @@index([lastMessageAt(sort: Desc)])
  @@index([kind])
}

// Prefer√™ncias do usu√°rio para cada thread (pin, archive, mute)
model ChatThreadPreference {
  threadId   String
  profileId  String
  isPinned   Boolean @default(false)
  pinnedAt   BigInt?
  isArchived Boolean @default(false)
  archivedAt BigInt?
  isMuted    Boolean @default(false)
  mutedAt    BigInt?

  thread ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@id([threadId, profileId])
  @@index([profileId, isPinned])
  @@index([profileId, isArchived])
}

model ChatMessage {
  id          String  @id @default(uuid())
  threadId    String
  fromProfile String
  type        String // text | audio | image | file | video | proposal | checkout | payment | system
  ciphertext  String  @db.Text
  mediaCid    String?
  meta        Json?
  createdAt   BigInt
  deliveredAt BigInt?
  readAt      BigInt?
  replyTo     String?
  editedAt    BigInt?
  deletedAt   BigInt?

  thread    ChatThread            @relation(fields: [threadId], references: [id], onDelete: Cascade)
  reactions ChatMessageReaction[]

  @@index([threadId, createdAt(sort: Desc)])
  @@index([fromProfile])
  @@index([type])
}

model ChatMessageReaction {
  id        String   @id @default(uuid())
  messageId String
  profileId String
  emoji     String // Unicode emoji: "üëç", "‚ù§Ô∏è", "üòÇ", etc
  createdAt DateTime @default(now())

  message ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  profile Profile     @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([messageId, profileId, emoji]) // Um usuario, um emoji por mensagem
  @@index([messageId])
  @@index([profileId])
}

model ChatGroup {
  id          String   @id @default(uuid())
  name        String
  description String?
  avatarUrl   String?
  kind        String   @default("community") // community | channel | dao
  isPublic    Boolean  @default(false)
  adminIds    String[]
  memberIds   String[]
  maxMembers  Int?     @default(500)
  metadata    Json?
  createdAt   BigInt

  @@index([adminIds])
  @@index([memberIds])
  @@index([kind])
  @@index([isPublic])
}

model ChatProposal {
  id                String  @id @default(uuid())
  threadId          String
  sellerId          String
  buyerId           String?
  items             Json // ProposalItem[]
  subtotal          Decimal @db.Decimal(20, 8)
  shipping          Json?
  total             Decimal @db.Decimal(20, 8)
  commissionPercent Int

  // Multi-Store Support
  isMultiStore Boolean @default(false)
  storeGroups  Json? // Array de StoreGroup[]

  status    String  @default("draft") // draft | sent | accepted | expired | paid
  expiresAt BigInt?
  createdAt BigInt
  updatedAt BigInt

  thread ChatThread      @relation(fields: [threadId], references: [id])
  sales  AffiliateSale[]

  @@index([threadId])
  @@index([sellerId])
  @@index([status])
}

model StoreCommissionPolicy {
  storeId            BigInt   @id
  mode               String   @default("open") // open | followers | affiliates
  percent            Int      @default(5)
  minReputation      Int?
  dailyCommissionCap Decimal? @db.Decimal(20, 8)
  allowMultiStore    Boolean  @default(true) // FASE 8: Multi-Store Proposals
  createdAt          BigInt
  updatedAt          BigInt
}

model ChatMission {
  id             String                  @id @default(uuid())
  title          String
  description    String
  reward         Decimal                 @db.Decimal(20, 8)
  type           String // share | review | referral | custom
  kind           String                  @default("custom") // onboarding | referral | sales | engagement
  goal           Int                     @default(1) // Quantidade necess√°ria para completar
  requirements   Json?
  maxCompletions Int?
  completedCount Int                     @default(0)
  expiresAt      BigInt?
  status         String                  @default("active") // active | paused | completed
  isActive       Boolean                 @default(true)
  createdBy      String
  createdAt      BigInt
  completions    ChatMissionCompletion[]

  @@index([status, expiresAt])
  @@index([createdBy])
  @@index([isActive])
}

model ChatMissionCompletion {
  profileId   String
  missionId   String
  progress    Int         @default(0)
  completedAt BigInt?
  mission     ChatMission @relation(fields: [missionId], references: [id], onDelete: Cascade)

  @@id([profileId, missionId])
  @@index([profileId])
  @@index([missionId])
}

model ChatOpportunity {
  id           String  @id @default(uuid())
  storeId      BigInt
  title        String
  description  String
  type         String // job | freelance | partnership
  compensation String?
  requirements Json?
  status       String  @default("open") // open | filled | closed
  createdAt    BigInt
  expiresAt    BigInt?

  @@index([storeId])
  @@index([status])
}

// AffiliateSale - MOCK de vendas on-chain (FASE 3)
// Esta tabela simula o que seria armazenado na blockchain
// Ser√° substitu√≠da por integra√ß√£o real posteriormente
model AffiliateSale {
  id String @id @default(uuid())

  // Link para marketplace (NOVO)
  marketplaceId String?
  marketplace   AffiliateMarketplace? @relation(fields: [marketplaceId], references: [id])

  storeId           BigInt
  buyer             String // profileId
  seller            String // profileId
  promoter          String? // profileId (opcional)
  amount            Decimal       @db.Decimal(20, 8)
  commissionPercent Int           @default(0)
  commissionAmount  Decimal       @default(0) @db.Decimal(20, 8)
  bazariFee         Decimal       @default(0) @db.Decimal(20, 8)
  sellerAmount      Decimal       @db.Decimal(20, 8)
  status            String        @default("pending") // pending, split, failed
  txHash            String? // Mock transaction hash
  receiptNftCid     String? // IPFS CID do recibo NFT
  proposalId        String?
  proposal          ChatProposal? @relation(fields: [proposalId], references: [id])
  createdAt         BigInt
  settledAt         BigInt?

  // ‚úÖ NEW: Blockchain reference (bazari-commerce pallet)
  blockchainSaleId BigInt?   @db.BigInt // On-chain SaleId (u64)
  blockchainTxHash String? // Real transaction hash (replaces MOCK txHash)
  onChainStatus    String? // Cache of on-chain status
  lastSyncedAt     DateTime? // Last time synced with blockchain

  @@index([storeId])
  @@index([buyer])
  @@index([seller])
  @@index([promoter])
  @@index([marketplaceId]) // NOVO
  @@index([status])
  @@index([proposalId])
  @@index([createdAt(sort: Desc)])
  @@index([blockchainSaleId])
}

// === FASE 7: Social Features ===

// Trust Badges NFT (MOCK)
model ChatTrustBadge {
  id        String  @id
  profileId String
  level     String // bronze | silver | gold | platinum
  nftId     String? // Mock NFT ID
  isActive  Boolean @default(true)
  issuedAt  BigInt

  @@index([profileId])
  @@index([isActive])
}

// Den√∫ncias e Modera√ß√£o (MOCK)
model ChatReport {
  id              String  @id
  reporterId      String
  reportedId      String
  contentType     String // message | profile | group
  contentId       String
  reason          String
  description     String  @default("")
  status          String  @default("pending") // pending | under_review | resolved
  votes           Int     @default(0)
  approveVotes    Int     @default(0)
  rejectVotes     Int     @default(0)
  resolution      String? // warning | suspend | ban | dismiss
  resolvedBy      String?
  resolvedAt      BigInt?
  resolutionNotes String?
  createdAt       BigInt

  @@index([reporterId])
  @@index([reportedId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
}

model ChatReportVote {
  reportId String
  voterId  String
  vote     String // approve | reject
  weight   Int    @default(1)
  votedAt  BigInt

  @@id([reportId, voterId])
  @@index([reportId])
  @@index([voterId])
}

// Polls em Grupos
model ChatGroupPoll {
  id        String  @id
  groupId   String
  creatorId String
  question  String
  options   Json // Array de op√ß√µes
  votes     Json    @default("{}") // Map de voterId -> optionIndex
  endsAt    BigInt?
  createdAt BigInt

  @@index([groupId])
  @@index([createdAt(sort: Desc)])
}

// === FASE 8: Affiliate System ===

// Sistema de Afiliados - Gerenciamento de promotores aprovados
model ChatStoreAffiliate {
  id         String  @id @default(uuid())
  storeId    BigInt // ID on-chain da loja
  promoterId String // profileId do promotor
  promoter   Profile @relation(fields: [promoterId], references: [id], onDelete: Cascade)

  // Status
  status String @default("pending") // pending | approved | rejected | suspended

  // Comiss√£o customizada (opcional - override da pol√≠tica geral)
  customCommission Int? // Se null, usa a pol√≠tica da loja

  // Limites opcionais
  monthlySalesCap Decimal? @db.Decimal(20, 8) // Limite mensal de vendas

  // Metadata
  notes String? @db.Text // Notas do dono da loja

  // Timestamps
  requestedAt BigInt // Quando solicitou
  approvedAt  BigInt? // Quando foi aprovado
  rejectedAt  BigInt? // Quando foi rejeitado
  suspendedAt BigInt? // Quando foi suspenso

  // Performance (calculado periodicamente)
  totalSales      Decimal @default(0) @db.Decimal(20, 8)
  totalCommission Decimal @default(0) @db.Decimal(20, 8)
  salesCount      Int     @default(0)

  createdAt BigInt
  updatedAt BigInt

  @@unique([storeId, promoterId])
  @@index([promoterId])
  @@index([storeId, status])
}

// Sistema de Convites de Afiliado (Opcional)
model ChatAffiliateInvite {
  id         String @id @default(uuid())
  storeId    BigInt
  inviteCode String @unique // C√≥digo √∫nico de convite

  // Configura√ß√µes do convite
  maxUses   Int? // N√∫mero m√°ximo de usos (null = ilimitado)
  usesCount Int     @default(0)
  expiresAt BigInt? // Data de expira√ß√£o

  // Auto-aprova√ß√£o
  autoApprove Boolean @default(false)

  // Comiss√£o padr√£o para quem usar este convite
  defaultCommission Int @default(5)

  createdAt BigInt

  @@index([storeId])
}

// === MARKETPLACE DO AFILIADO ===

// Marketplace personalizado do afiliado (vitrine)
model AffiliateMarketplace {
  id      String  @id @default(uuid())
  ownerId String
  owner   Profile @relation("AffiliateMarketplaces", fields: [ownerId], references: [id], onDelete: Cascade)

  // Branding
  name           String
  slug           String  @unique
  description    String? @db.Text
  logoUrl        String?
  bannerUrl      String?
  theme          String  @default("bazari")
  primaryColor   String?
  secondaryColor String?

  // Estat√≠sticas (cache)
  totalSales      Int     @default(0)
  totalRevenue    Decimal @default(0) @db.Decimal(20, 8)
  totalCommission Decimal @default(0) @db.Decimal(20, 8)
  productCount    Int     @default(0)

  // Status
  isActive Boolean @default(true)
  isPublic Boolean @default(true)

  createdAt BigInt
  updatedAt BigInt

  products AffiliateProduct[]
  sales    AffiliateSale[]

  @@index([ownerId])
  @@index([slug])
  @@index([isActive, isPublic])
}

// Produtos adicionados √† vitrine do afiliado
model AffiliateProduct {
  id            String               @id @default(uuid())
  marketplaceId String
  marketplace   AffiliateMarketplace @relation(fields: [marketplaceId], references: [id], onDelete: Cascade)

  // Produto original
  storeId         BigInt
  productId       String
  productName     String
  productImageUrl String?
  productPrice    Decimal @db.Decimal(20, 8)

  // Comiss√£o
  commissionPercent Int

  // Customiza√ß√µes (opcional)
  customDescription String? @db.Text
  customImageUrl    String?
  featured          Boolean @default(false)

  // Tracking
  viewCount  Int @default(0)
  clickCount Int @default(0)

  addedAt   BigInt
  updatedAt BigInt

  @@unique([marketplaceId, storeId, productId])
  @@index([marketplaceId])
  @@index([storeId])
}

// ===========================
// DELIVERY NETWORK (FASE 1)
// ===========================

model DeliveryRequest {
  id String @id @default(uuid())

  // Origem da demanda
  sourceType String // "order" | "direct"
  orderId    String? @unique
  order      Order?  @relation(fields: [orderId], references: [id])

  // Endere√ßos
  pickupAddress   Json // { street, number, complement?, city, state, zipCode, country, lat?, lng?, contactName?, contactPhone? }
  deliveryAddress Json // { street, number, complement?, city, state, zipCode, country, lat?, lng?, contactName?, contactPhone? }

  // Partes Envolvidas
  senderId    String // storeId (SellerProfile.id) ou profileId
  senderType  String // "store" | "profile"
  recipientId String // profileId do destinat√°rio

  // Detalhes da Carga
  packageType       String // "envelope" | "small_box" | "medium_box" | "large_box" | "fragile" | "perishable" | "custom"
  weight            Float?   @db.Real // em kg
  dimensions        Json? // { length: float, width: float, height: float } em cm
  estimatedValue    Decimal? @db.Decimal(20, 8) // valor estimado da mercadoria (para seguro)
  notes             String?  @db.Text
  requiresSignature Boolean  @default(true)

  // Valor e Pagamento
  deliveryFeeBzr Decimal @db.Decimal(20, 8)
  distance       Float?  @db.Real // em km (calculado)

  // Status
  status String @default("pending")
  // "pending" ‚Üí "assigned" ‚Üí "accepted" ‚Üí "picked_up" ‚Üí "in_transit" ‚Üí "delivered" ‚Üí "completed"
  // ou "cancelled" | "failed"

  // Entregador
  deliveryPersonId String?
  deliveryPerson   Profile? @relation("DeliveryPerson", fields: [deliveryPersonId], references: [id])

  // Rede de Entregadores
  preferredDeliverers String[] @default([]) // profileIds (ordem de prioridade)
  isPrivateNetwork    Boolean  @default(false) // true = s√≥ rede vinculada pode ver
  notifiedDeliverers  String[] @default([]) // hist√≥rico de quem foi notificado

  // Tracking de Tempo
  createdAt   BigInt
  updatedAt   BigInt
  expiresAt   BigInt? // prazo limite para aceite
  assignedAt  BigInt? // quando foi atribu√≠do
  acceptedAt  BigInt? // quando entregador aceitou
  pickedUpAt  BigInt? // quando coletou
  inTransitAt BigInt? // quando iniciou tr√¢nsito
  deliveredAt BigInt? // quando entregou
  completedAt BigInt? // quando foi finalizado/pago
  cancelledAt BigInt?

  // Escrow e Pagamento
  escrowAddress String?
  paymentTxHash String? // hash da transa√ß√£o de pagamento
  releaseTxHash String? // hash da libera√ß√£o do escrow

  // Prova de Entrega
  proofOfDelivery Json? // { signature?, photo_urls?: string[], timestamp: bigint }

  // Avalia√ß√£o
  rating        Int? // 1-5 estrelas
  reviewComment String? @db.Text

  // Metadados
  metadata Json? // campo flex√≠vel para dados extras

  // Relations
  waypoints DeliveryWaypoint[]
  reviews   CourierReview[]

  @@index([status])
  @@index([senderId, senderType])
  @@index([deliveryPersonId])
  @@index([orderId])
  @@index([createdAt])
  @@index([isPrivateNetwork])
}

model StoreDeliveryPartner {
  id String @id @default(uuid())

  // Rela√ß√£o
  storeId          BigInt // SellerProfile.onChainStoreId
  deliveryPersonId String // Profile.id
  deliveryPerson   Profile @relation("StoreDeliveryPartner", fields: [deliveryPersonId], references: [id], onDelete: Cascade)

  // Configura√ß√µes
  status   String @default("pending") // "pending" | "active" | "paused" | "suspended" | "rejected"
  priority Int    @default(1) // 1 = primeira oferta, 2 = segunda, etc.

  // Comiss√£o e Financeiro
  commissionPercent Int      @default(100) // % do deliveryFeeBzr que vai para o entregador
  bonusPerDelivery  Decimal? @db.Decimal(20, 8) // b√¥nus fixo por entrega

  // Restri√ß√µes
  maxDailyDeliveries Int? // limite de entregas por dia (null = sem limite)
  allowedDays        String[] @default([]) // ["monday", "tuesday", ...] - vazio = todos os dias
  workingHoursStart  String? // "08:00"
  workingHoursEnd    String? // "18:00"

  // M√©tricas (cache)
  totalDeliveries     Int    @default(0)
  completedDeliveries Int    @default(0)
  cancelledDeliveries Int    @default(0)
  avgRating           Float  @default(0)
  avgDeliveryTime     Float? @db.Real // em minutos
  onTimeRate          Float  @default(100.0) // %

  // Timestamps
  requestedAt BigInt? // quando entregador solicitou
  approvedAt  BigInt? // quando loja aprovou
  rejectedAt  BigInt?
  suspendedAt BigInt?
  createdAt   BigInt
  updatedAt   BigInt

  // Notas
  notes           String? @db.Text // notas privadas da loja sobre o entregador
  rejectionReason String? @db.Text

  @@unique([storeId, deliveryPersonId])
  @@index([storeId, status])
  @@index([deliveryPersonId, status])
  @@index([priority])
}

model DeliveryProfile {
  id        String  @id @default(uuid())
  profileId String  @unique
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  // Documenta√ß√£o
  fullName         String
  documentType     String // "cpf" | "cnpj" | "passport"
  documentNumber   String @unique
  phoneNumber      String
  emergencyContact Json? // { name: string, phone: string, relationship: string }

  // Ve√≠culo
  vehicleType  String // "bike" | "motorcycle" | "car" | "van" | "truck"
  vehiclePlate String?
  vehicleModel String?
  vehicleYear  Int?
  vehicleColor String?

  // Capacidades
  maxWeight          Float   @db.Real // kg
  maxVolume          Float   @db.Real // m¬≥
  canCarryFragile    Boolean @default(false)
  canCarryPerishable Boolean @default(false)
  hasInsulatedBag    Boolean @default(false) // bag t√©rmica

  // Disponibilidade
  isAvailable        Boolean @default(false)
  isOnline           Boolean @default(false) // conectado no momento
  currentLat         Float?  @db.Real
  currentLng         Float?  @db.Real
  currentAccuracy    Float?  @db.Real // em metros
  lastLocationUpdate BigInt?

  // √Årea de Atua√ß√£o
  serviceRadius          Float    @default(10.0) @db.Real // km
  serviceCities          String[] @default([]) // ["Rio de Janeiro", "Niter√≥i"]
  serviceStates          String[] @default([]) // ["RJ"]
  preferredNeighborhoods String[] @default([])

  // Estat√≠sticas
  totalDeliveries     Int   @default(0)
  completedDeliveries Int   @default(0)
  cancelledDeliveries Int   @default(0)
  avgRating           Float @default(0)
  totalRatings        Int   @default(0)
  onTimeRate          Float @default(100.0) // %
  acceptanceRate      Float @default(100.0) // % de entregas aceitas vs oferecidas
  completionRate      Float @default(100.0) // % de entregas completadas vs aceitas

  // Performance
  avgDeliveryTime Float? @db.Real // tempo m√©dio em minutos
  fastestDelivery Float? @db.Real // entrega mais r√°pida (minutos)
  totalDistance   Float  @default(0) @db.Real // km acumulados

  // Financeiro
  walletAddress   String? // endere√ßo blockchain para receber pagamentos
  totalEarnings   Decimal @default(0) @db.Decimal(20, 8) // BZR ganhos (hist√≥rico)
  pendingEarnings Decimal @default(0) @db.Decimal(20, 8) // BZR em escrow

  // Verifica√ß√£o
  isVerified               Boolean @default(false)
  verificationLevel        String  @default("basic") // "basic" | "intermediate" | "advanced"
  backgroundCheckCompleted Boolean @default(false)
  backgroundCheckDate      BigInt?

  // Configura√ß√µes
  autoAcceptRadius     Float?   @db.Real // km - aceita automaticamente dentro desse raio
  minDeliveryFee       Decimal? @db.Decimal(20, 8) // valor m√≠nimo de entrega que aceita
  notificationsEnabled Boolean  @default(true)

  // Status da Conta
  accountStatus    String  @default("active") // "active" | "suspended" | "banned" | "under_review"
  suspensionReason String? @db.Text
  suspendedUntil   BigInt?

  // Timestamps
  createdAt    BigInt
  updatedAt    BigInt
  lastActiveAt BigInt?
  verifiedAt   BigInt?

  // ‚úÖ NEW: Blockchain sync (bazari-fulfillment pallet)
  reviewsMerkleRoot      String? // Cache of on-chain Merkle root
  lastMerkleUpdate       DateTime? // Last time Merkle root was updated
  onChainReputationScore Int? // Cache of on-chain reputation score

  @@index([isAvailable, isOnline])
  @@index([profileId])
  @@index([documentNumber])
  @@index([serviceRadius])
  @@index([accountStatus])
  @@index([reviewsMerkleRoot])
}

// === DeliveryWaypoint (NEW) - GPS Tracking ===
model DeliveryWaypoint {
  id                String          @id @default(uuid())
  deliveryRequestId String
  deliveryRequest   DeliveryRequest @relation(fields: [deliveryRequestId], references: [id], onDelete: Cascade)
  latitude          Float           @db.Real
  longitude         Float           @db.Real
  accuracy          Float?          @db.Real // em metros
  altitude          Float?          @db.Real
  speed             Float?          @db.Real // m/s
  bearing           Float?          @db.Real // degrees
  timestamp         BigInt

  // ‚úÖ NEW: Proof tracking (bazari-attestation pallet)
  proofSubmitted Boolean @default(false) // Was this waypoint part of a proof?
  proofCid       String? // IPFS CID if submitted as HandoffProof/DeliveryProof

  @@index([deliveryRequestId, timestamp])
  @@index([proofSubmitted])
}

// === CourierReview (NEW) - Off-Chain Reviews ===
model CourierReview {
  id                String          @id @default(uuid())
  deliveryRequestId String
  deliveryRequest   DeliveryRequest @relation(fields: [deliveryRequestId], references: [id], onDelete: Cascade)
  courierId         String // Profile.id (delivery person)
  reviewerId        String // Profile.id (quem avaliou: sender ou recipient)
  rating            Int // 1-5 stars
  comment           String?         @db.Text
  createdAt         BigInt

  // ‚úÖ NEW: Merkle inclusion tracking (bazari-fulfillment pallet)
  merkleIncluded Boolean @default(false) // Was included in Merkle tree?
  merkleRootHash String? // Which Merkle root includes this review?

  @@index([courierId, createdAt])
  @@index([reviewerId])
  @@index([deliveryRequestId])
  @@index([courierId, merkleIncluded])
}

// ============================================================
// GOVERNANCE MODELS
// ============================================================

model GovernanceTreasuryRequest {
  id Int @id @default(autoincrement())

  // Dados da solicita√ß√£o
  title       String @db.VarChar(255)
  description String @db.Text
  value       String @db.VarChar(50) // Valor em planck (string para precis√£o)
  beneficiary String @db.VarChar(66) // Endere√ßo SS58
  proposer    String @db.VarChar(66) // Quem criou a solicita√ß√£o

  // Status e tracking
  status String @default("PENDING_REVIEW") @db.VarChar(50)
  // PENDING_REVIEW: Aguardando council analisar
  // IN_VOTING: Motion criado, aguardando votos
  // APPROVED: Motion aprovado, spend executado
  // REJECTED: Motion rejeitado pelo council
  // PAID_OUT: Pagamento realizado

  // Linkagem com blockchain
  councilMotionHash  String? @db.VarChar(66) // Hash do motion criado
  councilMotionIndex Int? // √çndice do motion
  spendId            Int? // ID do spend aprovado on-chain
  txHash             String? @db.VarChar(66) // Hash da tx de aprova√ß√£o
  blockNumber        Int? // Bloco de aprova√ß√£o

  // Assinatura para valida√ß√£o
  signature String @db.Text

  // Timestamps
  createdAt  DateTime  @default(now())
  reviewedAt DateTime?
  approvedAt DateTime?
  paidOutAt  DateTime?

  @@index([status])
  @@index([proposer])
  @@index([councilMotionHash])
  @@index([createdAt(sort: Desc)])
  @@map("governance_treasury_requests")
}

model GovernanceCouncilVote {
  id Int @id @default(autoincrement())

  motionHash  String  @db.VarChar(66)
  motionIndex Int
  voter       String  @db.VarChar(66) // Council member que votou
  vote        Boolean // true = AYE, false = NAY

  txHash      String   @db.VarChar(66)
  blockNumber Int
  timestamp   DateTime @default(now())

  @@unique([motionHash, motionIndex, voter])
  @@index([motionHash, motionIndex])
  @@map("governance_council_votes")
}

// Tabela para salvar propostas Democracy quando criadas
model GovernanceDemocracyProposal {
  id Int @id @default(autoincrement())

  // Dados da proposta on-chain
  proposalIndex Int     @unique
  proposalHash  String  @db.VarChar(66) // Hash da proposta
  preimageHash  String? @db.VarChar(66) // Hash do preimage (se dispon√≠vel)

  // Metadata extra√≠do do preimage/remark
  title       String  @db.VarChar(255)
  description String  @db.Text
  proposer    String? @db.VarChar(66) // Quem prop√¥s

  // Dados financeiros
  deposit String @db.VarChar(50) // Dep√≥sito em planck

  // Status
  status String @default("PROPOSED") @db.VarChar(50)
  // PROPOSED: Proposta criada, aguardando endorsements
  // STARTED: Virou referendum (migrado para GovernanceReferendum)
  // CANCELLED: Proposta cancelada

  // Blockchain data
  txHash      String @db.VarChar(66)
  blockNumber Int

  // Timestamps
  createdAt DateTime  @default(now())
  startedAt DateTime? // Quando virou referendum

  // Rela√ß√£o com referendum (se virou referendum)
  referendum GovernanceReferendum?

  @@index([proposalIndex])
  @@index([proposalHash])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("governance_democracy_proposals")
}

// Tabela para salvar referendos com metadata persistente
model GovernanceReferendum {
  id Int @id @default(autoincrement())

  // Dados do referendum on-chain
  refIndex  Int    @unique
  threshold String @db.VarChar(50) // VoteThreshold (SimpleMajority, SuperMajorityApprove, etc)

  // Metadata copiado da proposta original
  title       String  @db.VarChar(255)
  description String  @db.Text
  proposer    String? @db.VarChar(66)

  // Linkagem com proposta original
  proposalId   Int?    @unique
  proposalHash String? @db.VarChar(66)
  preimageHash String? @db.VarChar(66)

  // Status
  status String @default("ONGOING") @db.VarChar(50)
  // ONGOING: Referendum ativo, aceitando votos
  // APPROVED: Passou (ser√° executado)
  // REJECTED: N√£o passou
  // EXECUTED: Foi executado

  // Blockchain data
  startTxHash      String  @db.VarChar(66) // Tx do evento Started
  startBlockNumber Int // Bloco do evento Started
  endTxHash        String? @db.VarChar(66) // Tx do resultado final
  endBlockNumber   Int? // Bloco do resultado final

  // Timestamps
  createdAt  DateTime  @default(now()) // Quando Started
  endedAt    DateTime? // Quando Passed/NotPassed
  executedAt DateTime? // Quando Executed

  // Rela√ß√£o com proposta original (FK opcional)
  proposal GovernanceDemocracyProposal? @relation(fields: [proposalId], references: [id])

  @@index([refIndex])
  @@index([status])
  @@index([proposalHash])
  @@index([createdAt(sort: Desc)])
  @@map("governance_referendums")
}

// ============================================================================
// Blockchain Commerce Sync Models (for blockchain-sync.worker)
// ============================================================================

model BlockchainOrder {
  id          Int      @id @default(autoincrement())
  orderId     Int      @unique // On-chain order ID
  buyer       String   @db.VarChar(66)
  seller      String   @db.VarChar(66)
  marketplace Int
  totalAmount String   @db.VarChar(100) // Stored as string to preserve precision
  status      String   @default("CREATED") @db.VarChar(50) // CREATED, PROOF_SUBMITTED, DISPUTED, COMPLETED
  txHash      String   @db.VarChar(66)
  blockNumber Int
  createdAt   DateTime @default(now())

  @@index([orderId])
  @@index([buyer])
  @@index([seller])
  @@index([status])
  @@index([createdAt])
  @@map("blockchain_orders")
}

model DeliveryProof {
  id          Int      @id @default(autoincrement())
  orderId     Int
  proofCid    String   @db.VarChar(100) // IPFS CID
  attestor    String   @db.VarChar(66) // Courier who submitted proof
  txHash      String   @db.VarChar(66)
  blockNumber Int
  submittedAt DateTime @default(now())

  @@unique([orderId, proofCid])
  @@index([orderId])
  @@index([attestor])
  @@index([submittedAt])
  @@map("delivery_proofs")
}

model BlockchainDispute {
  id          Int      @id @default(autoincrement())
  disputeId   Int      @unique // On-chain dispute ID
  orderId     Int
  plaintiff   String   @db.VarChar(66)
  defendant   String   @db.VarChar(66)
  status      String   @default("OPENED") @db.VarChar(50) // OPENED, VOTING, RESOLVED
  txHash      String   @db.VarChar(66)
  blockNumber Int
  createdAt   DateTime @default(now())

  @@index([disputeId])
  @@index([orderId])
  @@index([plaintiff])
  @@index([defendant])
  @@index([status])
  @@index([createdAt])
  @@map("blockchain_disputes")
}

// ==================== BAZARI REWARDS (BLOCKCHAIN GAMIFICATION) ====================

model Mission {
  id            String   @id @default(cuid())
  missionId     Int      @unique // ID from blockchain
  title         String
  description   String   @db.Text
  missionType   String // FirstPurchase, CompleteNOrders, SpendAmount, ReferFriend, DailyLogin
  rewardAmount  String // ZARI amount (smallest unit, 12 decimals)
  requiredCount Int // Target value to complete
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())

  userProgress UserMissionProgress[]

  @@index([missionId])
  @@index([missionType])
  @@index([isActive])
  @@map("missions")
}

model UserMissionProgress {
  id           String    @id @default(cuid())
  userId       String
  missionId    Int
  currentCount Int       @default(0)
  isCompleted  Boolean   @default(false)
  isClaimed    Boolean   @default(false)
  completedAt  DateTime?
  claimedAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user    Profile @relation(fields: [userId], references: [id], onDelete: Cascade)
  mission Mission @relation(fields: [missionId], references: [missionId], onDelete: Cascade)

  @@unique([userId, missionId])
  @@index([userId])
  @@index([missionId])
  @@index([isCompleted])
  @@index([isClaimed])
  @@map("user_mission_progress")
}

model CashbackGrant {
  id             String   @id @default(cuid())
  userId         String
  orderAmount    String // BZR amount spent (smallest unit)
  cashbackAmount String // ZARI amount granted (smallest unit, 12 decimals)
  orderId        String? // Optional reference to order
  grantedAt      DateTime @default(now())

  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([grantedAt])
  @@index([orderId])
  @@map("cashback_grants")
}

// ==================== BAZARI VR MODELS ====================

// VR Session tracking (multiplayer)
model VRSession {
  id        String    @id @default(cuid())
  userId    String
  worldZone String // "plaza", "avenue", "auditorium", "building"
  enteredAt DateTime  @default(now())
  leftAt    DateTime?

  @@index([userId])
  @@index([worldZone])
  @@index([enteredAt])
  @@map("vr_sessions")
}

// Auditorium events
model AuditoriumEvent {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  startAt     DateTime
  endAt       DateTime
  hostUserId  String
  maxSeats    Int      @default(50)
  status      String   @default("scheduled") // "scheduled", "live", "ended", "cancelled"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([startAt])
  @@index([status])
  @@index([hostUserId])
  @@map("auditorium_events")
}

// Land NFT (terrenos virtuais)
model Land {
  id String @id @default(cuid())

  // Endere√ßamento √∫nico
  address   String @unique // "AVP-N-042", "PLC-C-001", etc.
  zone      String // "AVP", "PLC", "BGT", "BTH", "PCL", "GFD"
  sector    String // "N", "E", "S", "W", "A", "B", "C", "D"
  lotNumber Int

  // Posicionamento 3D
  positionX Float
  positionY Float
  positionZ Float
  rotation  Float @default(0) // Rota√ß√£o em radianos

  // Dimens√µes
  width Float // Largura em metros
  depth Float // Profundidade em metros
  area  Float // width * depth (m¬≤)

  // Classifica√ß√£o
  size String // "micro", "small", "medium", "large", "mega"
  tier String // "S", "A", "B", "C", "D"

  // NFT blockchain
  nftId       String? @unique // Token ID on-chain
  nftContract String? // Endere√ßo do contrato ERC-721

  // Propriedade
  ownerId String? // User.id do propriet√°rio

  // Aluguel
  isForRent   Boolean   @default(false)
  rentPrice   Decimal?  @db.Decimal(20, 12) // Pre√ßo em BZR por m√™s
  tenantId    String? // User.id do inquilino
  rentStartAt DateTime?
  rentEndsAt  DateTime?

  // Loja constru√≠da (rela√ß√£o 1:1)
  storeId String?        @unique // SellerProfile.id
  store   SellerProfile? @relation(fields: [storeId], references: [id])

  // Metadados
  isAvailable Boolean @default(true) // Se est√° √† venda
  basePrice   Decimal @db.Decimal(20, 12) // Pre√ßo base de compra em BZR

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([zone, sector, lotNumber])
  @@index([ownerId])
  @@index([tenantId])
  @@index([isAvailable])
  @@index([address])
  @@map("lands")
}

// ========================================
// VR Integration Models
// ========================================

model VRToken {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  token     String   @unique
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token, used])
  @@index([userId, createdAt])
}

// ========================================
// BazariOS App Store - Third Party Apps
// ========================================

model ThirdPartyApp {
  id String @id @default(cuid())

  // Identifica√ß√£o
  appId String @unique // ex: "com.dev.myapp"
  name  String
  slug  String @unique

  // Desenvolvedor
  developerId String
  developer   User   @relation("DeveloperApps", fields: [developerId], references: [id])

  // Metadados
  description     String
  longDescription String?
  category        String
  tags            String[]
  icon            String
  color           String
  screenshots     String[]

  // T√©cnico
  currentVersion String
  sdkVersion     String
  bundleUrl      String // URL do bundle (IPFS ou CDN)
  bundleHash     String // Hash para verifica√ß√£o

  // Permiss√µes
  permissions Json // Array de { id, reason, optional }

  // Status
  status   AppStatus @default(DRAFT)
  featured Boolean   @default(false)

  // M√©tricas
  installCount Int    @default(0)
  rating       Float?
  ratingCount  Int    @default(0)

  // Monetiza√ß√£o
  monetizationType MonetizationType @default(FREE)
  price            Decimal?         @db.Decimal(18, 8)
  currency         String           @default("BZR")

  // Revenue
  totalRevenue     Decimal @default(0) @db.Decimal(18, 8)
  developerRevenue Decimal @default(0) @db.Decimal(18, 8)
  platformRevenue  Decimal @default(0) @db.Decimal(18, 8)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // Review fields (TODO: integrar com governance/conselho)
  submittedAt DateTime?
  reviewedAt  DateTime?
  reviewerId  String?
  reviewNotes String?

  // Rela√ß√µes
  versions       AppVersion[]
  reviews        AppReview[]
  submissions    AppSubmission[]
  inAppPurchases InAppPurchase[]
  purchases      AppPurchase[]   @relation("AppPurchases")

  @@index([developerId])
  @@index([category])
  @@index([status])
  @@index([monetizationType])
}

model AppVersion {
  id    String        @id @default(cuid())
  appId String
  app   ThirdPartyApp @relation(fields: [appId], references: [id], onDelete: Cascade)

  version    String
  changelog  String?
  bundleUrl  String
  bundleHash String

  status VersionStatus @default(PENDING)

  createdAt   DateTime  @default(now())
  reviewedAt  DateTime?
  reviewedBy  String?
  reviewNotes String?

  @@unique([appId, version])
  @@index([appId])
}

model AppSubmission {
  id    String        @id @default(cuid())
  appId String
  app   ThirdPartyApp @relation(fields: [appId], references: [id], onDelete: Cascade)

  version String
  notes   String?

  status SubmissionStatus @default(PENDING)

  submittedAt DateTime  @default(now())
  reviewedAt  DateTime?
  reviewedBy  String?
  reviewNotes String?

  @@index([appId])
  @@index([status])
}

model AppReview {
  id    String        @id @default(cuid())
  appId String
  app   ThirdPartyApp @relation(fields: [appId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("AppReviews", fields: [userId], references: [id])

  rating  Int // 1-5
  comment String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([appId, userId])
  @@index([appId])
}

enum AppStatus {
  DRAFT
  PENDING // Aguardando in√≠cio do review
  PENDING_REVIEW // Legacy - alias for PENDING
  IN_REVIEW // Em an√°lise por reviewer
  APPROVED
  PUBLISHED
  REJECTED
  SUSPENDED
  DEPRECATED
  UNPUBLISHED // Removido da loja mas n√£o deletado
}

enum VersionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SubmissionStatus {
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
  CANCELLED
}

enum MonetizationType {
  FREE
  PAID
  FREEMIUM
  SUBSCRIPTION
}

enum PurchaseType {
  CONSUMABLE // Pode comprar m√∫ltiplas vezes
  NON_CONSUMABLE // Compra √∫nica permanente
  SUBSCRIPTION // Recorrente
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  FAILED
  REFUNDED
}

// ========================================
// BazariOS App Store - In-App Purchases
// ========================================

model InAppPurchase {
  id    String        @id @default(cuid())
  appId String
  app   ThirdPartyApp @relation(fields: [appId], references: [id], onDelete: Cascade)

  productId   String // ID √∫nico do produto no app
  name        String
  description String?
  price       Decimal      @db.Decimal(18, 8)
  currency    String       @default("BZR")
  type        PurchaseType

  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchases AppPurchase[] @relation("IAPPurchases")

  @@unique([appId, productId])
  @@index([appId])
}

model AppPurchase {
  id String @id @default(cuid())

  userId String
  user   User   @relation("UserAppPurchases", fields: [userId], references: [id])

  appId String
  app   ThirdPartyApp @relation("AppPurchases", fields: [appId], references: [id])

  inAppPurchaseId String?
  inAppPurchase   InAppPurchase? @relation("IAPPurchases", fields: [inAppPurchaseId], references: [id])

  type     String // "app" | "iap"
  amount   Decimal @db.Decimal(18, 8)
  currency String  @default("BZR")

  developerShare Decimal @db.Decimal(18, 8)
  platformShare  Decimal @db.Decimal(18, 8)

  txHash String? // Hash da transa√ß√£o blockchain
  status PaymentStatus @default(PENDING)

  createdAt   DateTime  @default(now())
  confirmedAt DateTime?

  // Refund fields
  refundedAt   DateTime?
  refundReason String?
  refundTxHash String?

  @@index([userId])
  @@index([appId])
  @@index([status])
}

// ========================================
// BazariOS Plugin System (Low-Code)
// ========================================

enum PluginCategory {
  ENGAGEMENT // Fidelidade, Gamifica√ß√£o
  MARKETING // Cupons, Promo√ß√µes
  OPERATIONS // Delivery, Estoque
  PAYMENTS // Cashback, Parcelamento
  ANALYTICS // Relat√≥rios, Insights
  COMMUNICATION // Chat, Notifica√ß√µes
}

enum PluginPricing {
  FREE
  PAID
  FREEMIUM
  USAGE_BASED
}

// Defini√ß√£o do plugin (template)
model PluginDefinition {
  id          String         @id @default(cuid())
  slug        String         @unique // "loyalty-program"
  name        String // "Programa de Fidelidade"
  description String         @db.Text
  version     String         @default("1.0.0")
  category    PluginCategory

  // Pricing
  pricingType  PluginPricing @default(FREE)
  priceMonthly Decimal?      @db.Decimal(18, 12)
  pricingTiers Json? // { "basic": 0, "pro": 10 }

  // Schema de configura√ß√£o (JSON Schema)
  configSchema  Json // Define campos configur√°veis
  defaultConfig Json // Valores padr√£o

  // Componentes que o plugin usa
  components Json // { "storePage": "LoyaltyWidget", ... }

  // Hooks (eventos que disparam a√ß√µes)
  hooks Json? // { "onPurchase": "addPoints", ... }

  // Smart contract associado (opcional)
  contractAddress String?
  contractAbi     Json?

  // Metadata
  iconUrl       String?
  bannerUrl     String?
  developerName String  @default("Bazari")
  isOfficial    Boolean @default(true)
  isActive      Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  instances PluginInstance[]

  @@index([category])
  @@index([isActive])
  @@index([slug])
}

// Inst√¢ncia do plugin (configura√ß√£o do lojista)
model PluginInstance {
  id String @id @default(cuid())

  pluginId String
  plugin   PluginDefinition @relation(fields: [pluginId], references: [id])

  sellerId String
  seller   SellerProfile @relation(fields: [sellerId], references: [id])

  storeId String?

  // Estado
  enabled Boolean @default(true)

  // Configura√ß√£o customizada pelo lojista
  config   Json // Valores espec√≠ficos do lojista
  branding Json? // Cores, logo, etc

  // Dados runtime
  stats Json? // Estat√≠sticas de uso

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Rela√ß√£o com dados de fidelidade
  loyaltyPoints    LoyaltyPoints[]
  pendingCashbacks PendingCashback[]

  @@unique([pluginId, sellerId, storeId])
  @@index([sellerId])
  @@index([pluginId])
  @@index([enabled])
}

// Pontos de fidelidade por usu√°rio/loja
model LoyaltyPoints {
  id String @id @default(cuid())

  instanceId String
  instance   PluginInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  userId      String // User.id ou Profile.id
  points      Int    @default(0)
  totalEarned Int    @default(0) // Total acumulado (hist√≥rico)
  tier        String @default("bronze") // bronze, silver, gold, platinum

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([instanceId, userId])
  @@index([instanceId])
  @@index([userId])
  @@index([tier])
}

// Cashback pendente
model PendingCashback {
  id String @id @default(cuid())

  pluginInstanceId String
  pluginInstance   PluginInstance @relation(fields: [pluginInstanceId], references: [id], onDelete: Cascade)

  orderId String
  userId  String
  amount  Decimal @db.Decimal(20, 12) // Valor em BZR (planck)

  scheduledFor DateTime // Quando ser√° creditado
  status       CashbackStatus @default(PENDING)

  creditedAt DateTime?
  txHash     String? // Hash da transa√ß√£o quando creditado

  createdAt DateTime @default(now())

  @@index([pluginInstanceId])
  @@index([userId])
  @@index([orderId])
  @@index([status])
  @@index([scheduledFor])
}

enum CashbackStatus {
  PENDING
  CREDITED
  CANCELLED
  FAILED
}

// ============================================
// DEVELOPER APP REGISTRY (SDK Security)
// ============================================

// Status de um app de desenvolvedor
enum DeveloperAppStatus {
  PENDING // Aguardando aprova√ß√£o
  APPROVED // Aprovado e ativo
  SUSPENDED // Suspenso temporariamente
  REJECTED // Rejeitado
}

// App registrado por um desenvolvedor
model DeveloperApp {
  id String @id @default(cuid())

  // Rela√ß√£o com desenvolvedor
  developerId String
  developer   Profile @relation("DeveloperApps", fields: [developerId], references: [id], onDelete: Cascade)

  // Informa√ß√µes b√°sicas
  name        String
  slug        String  @unique // URL-friendly identifier
  description String?
  websiteUrl  String?

  // Credenciais de API
  apiKey        String  @unique // baz_app_xxxxx (produ√ß√£o) ou baz_test_xxxxx (sandbox)
  secretKeyHash String? // Hash da secret key para HMAC (nunca armazena plain text)

  // Seguran√ßa
  allowedOrigins String[] // Origens permitidas para postMessage
  permissions    String[] // Permiss√µes concedidas (ex: wallet:read, wallet:transfer)

  // Status e modera√ß√£o
  status      DeveloperAppStatus @default(PENDING)
  reviewNotes String? // Notas do revisor
  reviewedAt  DateTime?
  reviewedBy  String? // Profile ID do admin que revisou

  // Rate limiting customizado (opcional)
  rateLimitCapacity   Int? // Capacidade do bucket (default: 100)
  rateLimitRefillRate Int? // Tokens por segundo (default: 10)

  // Estat√≠sticas
  totalRequests BigInt    @default(0)
  lastRequestAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Logs de uso
  usageLogs DeveloperAppUsageLog[]

  @@index([developerId])
  @@index([status])
  @@index([apiKey])
}

// Log de uso de apps (para analytics e auditoria)
model DeveloperAppUsageLog {
  id String @id @default(cuid())

  appId String
  app   DeveloperApp @relation(fields: [appId], references: [id], onDelete: Cascade)

  // Detalhes da requisi√ß√£o
  messageType String // Tipo de mensagem (ex: wallet:getBalance)
  success     Boolean
  errorCode   String? // C√≥digo de erro se falhou

  // Metadados
  userAgent String?
  origin    String? // Origem da requisi√ß√£o

  // Performance
  responseTimeMs Int? // Tempo de resposta em ms

  createdAt DateTime @default(now())

  @@index([appId])
  @@index([messageType])
  @@index([createdAt])
  @@index([success])
}

// =====================================================
// STATUS/STORIES (BazChat Fase 05)
// =====================================================

enum StoryType {
  TEXT
  IMAGE
  VIDEO
}

model Story {
  id        String  @id @default(cuid())
  profileId String
  profile   Profile @relation(fields: [profileId], references: [id])

  // Conte√∫do
  type            StoryType // TEXT, IMAGE, VIDEO
  text            String? // Texto (para TEXT ou caption)
  textColor       String? // Cor do texto (hex)
  backgroundColor String? // Cor de fundo para TEXT
  mediaCid        String? // CID do IPFS para IMAGE/VIDEO
  mediaType       String? // image/jpeg, video/mp4, etc
  duration        Int? // Dura√ß√£o em segundos (para video)

  // Metadata
  createdAt DateTime @default(now())
  expiresAt DateTime // createdAt + 24h
  viewCount Int      @default(0)

  // Rela√ß√µes
  views   StoryView[]
  replies StoryReply[]

  @@index([profileId, expiresAt])
  @@index([expiresAt])
}

model StoryView {
  id       String   @id @default(cuid())
  storyId  String
  story    Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  viewerId String
  viewer   Profile  @relation(fields: [viewerId], references: [id])
  viewedAt DateTime @default(now())

  @@unique([storyId, viewerId])
  @@index([storyId])
}

model StoryReply {
  id        String   @id @default(cuid())
  storyId   String
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  fromId    String
  from      Profile  @relation(fields: [fromId], references: [id])
  message   String // Mensagem de resposta
  createdAt DateTime @default(now())

  @@index([storyId])
}

// =====================================================
// CHAMADAS DE VOZ/VIDEO (BazChat Fase 05)
// =====================================================

enum CallType {
  VOICE
  VIDEO
}

enum CallStatus {
  RINGING // Chamando
  ONGOING // Em andamento
  ENDED // Encerrada normalmente
  MISSED // N√£o atendida (timeout)
  REJECTED // Recusada
  BUSY // Ocupado (j√° em outra chamada)
}

model Call {
  id       String     @id @default(cuid())
  threadId String
  thread   ChatThread @relation(fields: [threadId], references: [id])

  callerId String
  caller   Profile @relation("CallsCaller", fields: [callerId], references: [id])
  calleeId String
  callee   Profile @relation("CallsCallee", fields: [calleeId], references: [id])

  type   CallType // VOICE, VIDEO
  status CallStatus // RINGING, ONGOING, ENDED, MISSED, REJECTED, BUSY

  startedAt DateTime? // Quando foi atendida
  endedAt   DateTime?
  duration  Int? // Dura√ß√£o em segundos

  createdAt DateTime @default(now())

  @@index([threadId])
  @@index([callerId])
  @@index([calleeId])
}

/// === Web Push Subscriptions ===
model PushSubscription {
  id        String  @id @default(cuid())
  profileId String
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  // Push subscription data (from browser)
  endpoint String @unique
  p256dh   String // Keys.p256dh
  auth     String // Keys.auth

  // Device info for management
  userAgent String?
  deviceId  String? // Optional device identifier

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([profileId])
}

/// === Bazari Work - Job Postings (PROMPT-03) ===

enum JobPostingStatus {
  DRAFT
  OPEN
  PAUSED
  CLOSED
}

enum PaymentPeriod {
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
  PROJECT
}

enum ApplicationStatus {
  PENDING
  REVIEWED
  SHORTLISTED
  REJECTED
  HIRED
}

model JobPosting {
  id String @id @default(cuid())

  // Empresa (SellerProfile como empresa)
  sellerProfileId String
  sellerProfile   SellerProfile @relation(fields: [sellerProfileId], references: [id], onDelete: Cascade)
  createdById     String
  createdBy       Profile       @relation("JobPostingCreatedBy", fields: [createdById], references: [id])

  // Detalhes da vaga
  title       String
  description String         @db.Text
  area        String
  skills      String[]
  workType    WorkPreference
  location    String?

  // Valores (informativos)
  paymentValue    Decimal?       @db.Decimal(10, 2)
  paymentPeriod   PaymentPeriod?
  paymentCurrency String         @default("BRL")

  // Status
  status JobPostingStatus @default(DRAFT)

  // Metadados
  publishedAt DateTime?
  closedAt    DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Rela√ß√µes
  applications JobApplication[]
  proposals    WorkProposal[]

  @@index([sellerProfileId])
  @@index([status])
  @@index([area])
  @@index([skills], type: Gin)
  @@index([workType])
  @@index([publishedAt])
  @@index([createdAt])
}

model JobApplication {
  id String @id @default(cuid())

  // Rela√ß√£o com vaga
  jobPostingId String
  jobPosting   JobPosting @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)

  // Candidato (Profile)
  applicantId String
  applicant   Profile @relation("JobApplicationApplicant", fields: [applicantId], references: [id], onDelete: Cascade)

  // Dados da candidatura
  coverLetter   String?  @db.Text
  expectedValue Decimal? @db.Decimal(10, 2)

  // Status
  status ApplicationStatus @default(PENDING)

  // Timestamps
  appliedAt  DateTime  @default(now())
  reviewedAt DateTime?

  @@unique([jobPostingId, applicantId])
  @@index([jobPostingId])
  @@index([applicantId])
  @@index([status])
  @@index([appliedAt])
}

// === BAZARI WORK: Proposals (PROMPT-04) ===
enum ProposalStatus {
  PENDING
  NEGOTIATING
  ACCEPTED
  REJECTED
  EXPIRED
  CANCELLED
}

enum PaymentType {
  EXTERNAL
  BAZARI_PAY
  UNDEFINED
}

model WorkProposal {
  id String @id @default(cuid())

  // Empresa (SellerProfile atua como Company)
  sellerProfileId String
  sellerProfile   SellerProfile @relation(fields: [sellerProfileId], references: [id], onDelete: Cascade)

  // Remetente (quem enviou a proposta - dono da empresa)
  senderId String
  sender   Profile @relation("WorkProposalSender", fields: [senderId], references: [id])

  // Receptor (profissional)
  receiverId String
  receiver   Profile @relation("WorkProposalReceiver", fields: [receiverId], references: [id])

  // V√≠nculo opcional com vaga
  jobPostingId String?
  jobPosting   JobPosting? @relation(fields: [jobPostingId], references: [id], onDelete: SetNull)

  // Detalhes da proposta
  title         String
  description   String        @db.Text
  proposedValue Decimal       @db.Decimal(10, 2)
  valuePeriod   PaymentPeriod
  valueCurrency String        @default("BRL")
  startDate     DateTime?
  duration      String?
  paymentType   PaymentType   @default(UNDEFINED)

  // Status
  status ProposalStatus @default(PENDING)

  // Thread de chat vinculada
  chatThreadId String?

  // Timestamps
  expiresAt   DateTime
  respondedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Rela√ß√£o com acordo
  agreement WorkAgreement?

  @@unique([sellerProfileId, receiverId, status], name: "unique_active_proposal")
  @@index([sellerProfileId])
  @@index([senderId])
  @@index([receiverId])
  @@index([jobPostingId])
  @@index([status])
  @@index([expiresAt])
  @@index([createdAt])
}

// === BAZARI WORK: Agreements (PROMPT-05) ===
enum AgreementStatus {
  ACTIVE
  PAUSED
  CLOSED
}

model WorkAgreement {
  id String @id @default(cuid())

  // Empresa (SellerProfile)
  sellerProfileId String
  sellerProfile   SellerProfile @relation(fields: [sellerProfileId], references: [id], onDelete: Cascade)

  // Trabalhador (Profile do profissional)
  workerId String
  worker   Profile @relation("WorkAgreementWorker", fields: [workerId], references: [id])

  // Origem (proposta aceita)
  proposalId String?       @unique
  proposal   WorkProposal? @relation(fields: [proposalId], references: [id], onDelete: SetNull)

  // Termos do acordo
  title         String
  description   String?       @db.Text
  terms         String?       @db.Text
  agreedValue   Decimal       @db.Decimal(10, 2)
  valuePeriod   PaymentPeriod
  valueCurrency String        @default("BRL")

  // Datas
  startDate DateTime
  endDate   DateTime?

  // Status e pagamento
  status      AgreementStatus @default(ACTIVE)
  paymentType PaymentType

  // On-chain (opcional)
  onChainId     String? @unique
  onChainTxHash String?

  // Integra√ß√£o Bazari Pay (futuro)
  payContractId String?

  // Timestamps e metadados
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  pausedAt     DateTime?
  closedAt     DateTime?
  closedReason String?

  // Rela√ß√µes
  statusHistory AgreementStatusHistory[]
  evaluations   WorkEvaluation[]

  @@index([sellerProfileId])
  @@index([workerId])
  @@index([status])
  @@index([createdAt])
}

model AgreementStatusHistory {
  id String @id @default(cuid())

  // Acordo
  agreementId String
  agreement   WorkAgreement @relation(fields: [agreementId], references: [id], onDelete: Cascade)

  // Mudan√ßa
  fromStatus AgreementStatus
  toStatus   AgreementStatus
  reason     String?

  // Quem fez a mudan√ßa
  changedById String
  changedBy   Profile @relation("AgreementStatusChangedBy", fields: [changedById], references: [id])

  // Timestamp
  createdAt DateTime @default(now())

  @@index([agreementId])
  @@index([createdAt])
}

// ===========================
// PROMPT-07: Avalia√ß√µes Work
// ===========================

enum EvaluationCommentStatus {
  PENDING
  APPROVED
  REJECTED
}

model WorkEvaluation {
  id String @id @default(uuid())

  // Acordo avaliado
  agreementId String
  agreement   WorkAgreement @relation(fields: [agreementId], references: [id], onDelete: Cascade)

  // Quem avalia (Profile)
  authorId String
  author   Profile @relation("WorkEvaluationAuthor", fields: [authorId], references: [id])

  // Quem √© avaliado (Profile)
  targetId String
  target   Profile @relation("WorkEvaluationTarget", fields: [targetId], references: [id])

  // Notas (1-5)
  overallRating       Int
  communicationRating Int?
  punctualityRating   Int?
  qualityRating       Int?

  // Coment√°rio
  comment       String?                 @db.Text
  commentStatus EvaluationCommentStatus @default(PENDING)

  // Visibilidade (s√≥ p√∫blico ap√≥s ambos avaliarem)
  isPublic Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())

  @@unique([agreementId, authorId])
  @@index([agreementId])
  @@index([authorId])
  @@index([targetId])
  @@index([isPublic])
  @@index([createdAt])
}

// ============================================================================
// BAZARI PAY - Pagamentos Recorrentes (PROMPT-01)
// ============================================================================

enum PayPeriod {
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum PayContractStatus {
  ACTIVE
  PAUSED
  CLOSED
}

model PayContract {
  id String @id @default(uuid())

  // Partes
  payerId        String
  payer          User           @relation("PayContractPayer", fields: [payerId], references: [id])
  payerCompanyId String?
  payerCompany   SellerProfile? @relation("PayContractPayerCompany", fields: [payerCompanyId], references: [id])
  receiverId     String
  receiver       User           @relation("PayContractReceiver", fields: [receiverId], references: [id])

  // Wallets
  payerWallet    String
  receiverWallet String

  // Valores
  baseValue Decimal @db.Decimal(18, 8)
  currency  String  @default("BZR")

  // Periodicidade
  period     PayPeriod
  paymentDay Int // 1-28

  // Datas
  startDate       DateTime
  endDate         DateTime?
  nextPaymentDate DateTime

  // Status
  status PayContractStatus @default(ACTIVE)

  // Descri√ß√£o
  description String?

  // Refer√™ncia externa (ex: Work Agreement)
  referenceType String?
  referenceId   String?

  // On-chain (ser√° preenchido na Fase 4)
  onChainId     String? @unique
  onChainTxHash String?

  // Metadados
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  pausedAt  DateTime?
  closedAt  DateTime?

  // Rela√ß√µes
  statusHistory PayContractStatusHistory[]
  executions    PayExecution[]
  adjustments   PayAdjustment[]

  @@index([payerId])
  @@index([payerCompanyId])
  @@index([receiverId])
  @@index([status])
  @@index([nextPaymentDate])
  @@index([createdAt])
  @@map("pay_contracts")
}

model PayContractStatusHistory {
  id String @id @default(uuid())

  // Contrato
  contractId String
  contract   PayContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  // Mudan√ßa
  fromStatus PayContractStatus
  toStatus   PayContractStatus
  reason     String?

  // Quem fez a mudan√ßa
  changedById String
  changedBy   User   @relation("PayContractStatusChangedBy", fields: [changedById], references: [id])

  // Timestamp
  createdAt DateTime @default(now())

  @@index([contractId])
  @@index([createdAt])
  @@map("pay_contract_status_history")
}

// Bazari Pay - Execu√ß√µes de Pagamento (PROMPT-02)
enum ExecutionStatus {
  SCHEDULED
  PROCESSING
  SUCCESS
  FAILED
  RETRYING
  SKIPPED
}

model PayExecution {
  id String @id @default(uuid())

  // Contrato
  contractId String
  contract   PayContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  // Per√≠odo de refer√™ncia
  periodStart DateTime
  periodEnd   DateTime
  periodRef   String // "2025-02" formato YYYY-MM

  // Valores
  baseValue        Decimal @db.Decimal(18, 8)
  adjustmentsTotal Decimal @default(0) @db.Decimal(18, 8)
  finalValue       Decimal @db.Decimal(18, 8)
  currency         String  @default("BZR")

  // Status
  status        ExecutionStatus @default(SCHEDULED)
  attemptCount  Int             @default(1)
  failureReason String?

  // On-chain
  txHash      String?
  blockNumber Int?

  // Datas
  scheduledAt DateTime
  executedAt  DateTime?
  nextRetryAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Rela√ß√£o com ajustes
  adjustments PayAdjustment[]

  @@index([contractId])
  @@index([status])
  @@index([scheduledAt])
  @@index([periodRef])
  @@index([createdAt])
  @@map("pay_executions")
}

// Bazari Pay - Ajustes (PROMPT-03)
enum AdjustmentType {
  EXTRA
  DISCOUNT
}

enum AdjustmentStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
  APPLIED
  CANCELLED
}

model PayAdjustment {
  id String @id @default(uuid())

  // Contrato
  contractId String
  contract   PayContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  // Tipo e valor
  type  AdjustmentType
  value Decimal        @db.Decimal(18, 8)

  // Per√≠odo de refer√™ncia
  referenceMonth DateTime

  // Detalhes
  reason      String
  description String?
  attachments String[] @default([])

  // Aprova√ß√£o
  requiresApproval Boolean          @default(false)
  status           AdjustmentStatus @default(DRAFT)
  approvedAt       DateTime?
  approvedById     String?
  approvedBy       User?            @relation("PayAdjustmentApprovedBy", fields: [approvedById], references: [id])
  rejectionReason  String?

  // Aplica√ß√£o
  executionId String?
  execution   PayExecution? @relation(fields: [executionId], references: [id])

  // Metadados
  createdById String
  createdBy   User     @relation("PayAdjustmentCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([contractId])
  @@index([status])
  @@index([referenceMonth])
  @@index([executionId])
  @@index([createdById])
  @@map("pay_adjustments")
}

// Bazari Pay - Enterprise (PROMPT-06)

enum BatchImportStatus {
  PENDING
  PROCESSING
  COMPLETED
  COMPLETED_WITH_ERRORS
  FAILED
}

model PayBatchImport {
  id String @id @default(uuid())

  // Empresa
  companyId String
  company   SellerProfile @relation("PayBatchImportCompany", fields: [companyId], references: [id])

  // Arquivo
  fileName      String
  fileSize      Int?
  totalRows     Int
  processedRows Int    @default(0)
  createdCount  Int    @default(0)
  failedCount   Int    @default(0)

  // Status
  status BatchImportStatus @default(PENDING)

  // Dados e erros
  data   Json? // Array de linhas CSV
  errors Json? // Array de erros por linha

  // Quem fez o upload
  uploadedById String
  uploadedBy   User   @relation("PayBatchImportUploadedBy", fields: [uploadedById], references: [id])

  // Timestamps
  createdAt   DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?

  @@index([companyId])
  @@index([status])
  @@index([uploadedById])
  @@index([createdAt])
  @@map("pay_batch_imports")
}

enum ApiKeyStatus {
  ACTIVE
  REVOKED
}

model PayApiKey {
  id String @id @default(uuid())

  // Empresa
  companyId String
  company   SellerProfile @relation("PayApiKeyCompany", fields: [companyId], references: [id])

  // Chave
  name      String
  keyHash   String @unique
  keyPrefix String // Primeiros 8 caracteres para identifica√ß√£o

  // Permiss√µes
  permissions String[] @default(["contracts:read", "contracts:write"])

  // Status
  status ApiKeyStatus @default(ACTIVE)

  // Uso
  lastUsedAt DateTime?
  usageCount Int       @default(0)

  // Metadados
  createdById String
  createdBy   User      @relation("PayApiKeyCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime  @default(now())
  revokedAt   DateTime?

  @@index([companyId])
  @@index([keyHash])
  @@index([status])
  @@map("pay_api_keys")
}

model PayWebhook {
  id String @id @default(uuid())

  // Empresa
  companyId String
  company   SellerProfile @relation("PayWebhookCompany", fields: [companyId], references: [id])

  // Configura√ß√£o
  name   String?
  url    String
  secret String? // Para validar assinatura

  // Eventos
  events String[] @default(["payment.success", "payment.failed"])

  // Status
  active Boolean @default(true)

  // Estat√≠sticas
  lastCalledAt DateTime?
  successCount Int       @default(0)
  failureCount Int       @default(0)

  // Metadados
  createdById String
  createdBy   User     @relation("PayWebhookCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId])
  @@index([active])
  @@map("pay_webhooks")
}
