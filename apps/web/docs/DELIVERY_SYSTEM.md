# Sistema de Entregas - Bazari Delivery Network

## üìã Vis√£o Geral

Sistema completo de entregas peer-to-peer (P2P) integrado ao ecossistema Bazari. Permite que qualquer usu√°rio solicite entregas e que entregadores aceitem e completem essas entregas de forma descentralizada, com pagamentos via BZR token e gest√£o de reputa√ß√£o.

## üéØ Funcionalidades Principais

### 1. Solicita√ß√£o de Entregas
- Usu√°rios podem solicitar entregas diretas (sem v√≠nculo com pedidos)
- C√°lculo autom√°tico de taxa baseado em dist√¢ncia, tipo de pacote e peso
- Sistema de escrow para prote√ß√£o de pagamento
- Rastreamento em tempo real do status da entrega

### 2. Perfil de Entregador
- Cadastro completo com informa√ß√µes pessoais, ve√≠culo e disponibilidade
- Sistema de disponibilidade online/offline
- Dashboard com KPIs e estat√≠sticas
- Hist√≥rico de entregas e ganhos

### 3. Marketplace de Entregas
- Lista de entregas dispon√≠veis com filtros avan√ßados
- Sistema de aceita√ß√£o first-come-first-served
- Notifica√ß√µes para entregadores parceiros de lojas

### 4. Gest√£o de Parceiros (Lojistas)
- Lojistas podem vincular entregadores preferidos
- Sistema de prioriza√ß√£o de entregadores
- Estat√≠sticas de desempenho de cada parceiro

## üöÄ Fluxos de Usu√°rio

### Fluxo 1: Solicitar Entrega Direta

**Rota:** `/app/delivery/request/new`

**Etapas:**
1. **Endere√ßos**: Informar coleta e entrega com contatos
2. **Pacote**: Tipo, peso, instru√ß√µes especiais + c√°lculo de taxa
3. **Confirma√ß√£o**: Revisar e confirmar com pagamento via escrow

**Resultado:** Entrega criada e dispon√≠vel para entregadores

---

### Fluxo 2: Tornar-se Entregador

**Rota:** `/app/delivery/profile/setup`

**Etapas:**
1. **Informa√ß√µes Pessoais**: Nome, CPF, telefone, endere√ßo base, foto
2. **Ve√≠culo**: Tipo, marca, modelo, placa, cor, capacidade
3. **Disponibilidade**: Raio de atua√ß√£o, dias, turnos, entregas imediatas
4. **Confirma√ß√£o**: Revisar e aceitar termos

**Resultado:** Perfil de entregador criado, pode come√ßar a aceitar entregas

---

### Fluxo 3: Dashboard do Entregador

**Rota:** `/app/delivery/dashboard`

**Visualiza√ß√µes:**
- **KPIs**: Entregas hoje, ganhos do dia, taxa de conclus√£o, avalia√ß√£o m√©dia
- **Toggle Online/Offline**: Controle de disponibilidade
- **Quick Actions**: Demandas, ativas, hist√≥rico, ganhos
- **Lista de Ativas**: Entregas em andamento
- **Estat√≠sticas Semanais**: Gr√°fico de entregas por dia

---

### Fluxo 4: Aceitar e Completar Entregas

**Lista de Demandas:** `/app/delivery/requests`

**Filtros Dispon√≠veis:**
- Dist√¢ncia m√°xima (1-50km)
- Valor m√≠nimo (BZR)
- Tipo de pacote (documento, pequeno, m√©dio, grande)

**Ordena√ß√£o:**
- Mais pr√≥ximas
- Maior valor
- Mais recentes

**Entrega Ativa:** `/app/delivery/active/:id`

**Status da Entrega:**
1. **pending** ‚Üí Aguardando aceita√ß√£o
2. **accepted** ‚Üí Entregador aceitou (pode confirmar coleta)
3. **picked_up** ‚Üí Pacote coletado (em rota para entrega)
4. **in_transit** ‚Üí Em tr√¢nsito
5. **delivered** ‚Üí Entregue (pagamento liberado)
6. **cancelled** ‚Üí Cancelada

**A√ß√µes Dispon√≠veis:**
- Confirmar Coleta (accepted ‚Üí picked_up)
- Confirmar Entrega (picked_up ‚Üí delivered)
- Cancelar Entrega (qualquer status ‚Üí cancelled)
- Ligar para contato
- Enviar WhatsApp
- Abrir navega√ß√£o GPS

---

### Fluxo 5: Gerenciar Parceiros (Lojistas)

**Rota:** `/app/store/delivery-partners`

**Funcionalidades:**
- Listar parceiros vinculados (ordenados por prioridade)
- Convidar novos parceiros (por ID do perfil)
- Editar prioridade de parceiros
- Remover parceiros
- Ver estat√≠sticas de cada parceiro

**Sistema de Prioridade:**
- Quando uma loja cria entrega, notifica parceiros por ordem de prioridade
- Primeiro a aceitar fica com a entrega

---

## üß© Componentes Reutiliz√°veis

Todos os componentes est√£o em `apps/web/src/components/delivery/`

### StepIndicator
**Uso:** Indicador de progresso para formul√°rios multi-step

**Props:**
```typescript
{
  currentStep: number;
  totalSteps: number;
  steps: string[];
}
```

**Exemplo:**
```tsx
<StepIndicator currentStep={2} totalSteps={3} steps={['Endere√ßos', 'Pacote', 'Confirmar']} />
```

---

### KPICard
**Uso:** Card de m√©trica com √≠cone, label e valor

**Props:**
```typescript
{
  icon: React.ReactNode;
  label: string;
  value: string | number;
  trend?: string;
  color?: string;
}
```

**Exemplo:**
```tsx
<KPICard
  icon={<Package />}
  label="Entregas Hoje"
  value={12}
  trend="+3"
  color="text-blue-600"
/>
```

---

### AddressCard
**Uso:** Card de endere√ßo com contato e a√ß√µes

**Props:**
```typescript
{
  title: string;
  address: Address;
  contact: ContactInfo;
  onCall?: () => void;
  onWhatsApp?: () => void;
  onNavigate?: () => void;
}
```

**Exemplo:**
```tsx
<AddressCard
  title="Coleta"
  address={pickupAddress}
  contact={pickupContact}
  onCall={() => window.location.href = `tel:${contact.phone}`}
  onNavigate={() => openGoogleMaps(address)}
/>
```

---

### FeeBreakdownCard
**Uso:** Breakdown detalhado da taxa de entrega

**Props:**
```typescript
{
  breakdown: {
    baseFee: string;
    distanceFee: string;
    packageTypeFee: string;
    weightFee: string;
  };
  totalBzr: string;
  distance: number;
  estimatedTime: number;
}
```

**Exemplo:**
```tsx
<FeeBreakdownCard
  breakdown={feeResult.breakdown}
  totalBzr={feeResult.totalBzr}
  distance={feeResult.distance}
  estimatedTime={feeResult.estimatedTime}
/>
```

---

### DeliveryStatusTimeline
**Uso:** Timeline visual do status da entrega

**Props:**
```typescript
{
  currentStatus: DeliveryRequestStatus;
  timestamps: {
    createdAt: string;
    acceptedAt?: string;
    pickedUpAt?: string;
    deliveredAt?: string;
  };
}
```

**Exemplo:**
```tsx
<DeliveryStatusTimeline
  currentStatus="picked_up"
  timestamps={{
    createdAt: delivery.createdAt,
    acceptedAt: delivery.acceptedAt,
    pickedUpAt: delivery.pickedUpAt,
  }}
/>
```

---

### QuickActionButton
**Uso:** Bot√£o de a√ß√£o r√°pida com √≠cone e badge

**Props:**
```typescript
{
  icon: React.ReactNode;
  label: string;
  badge?: number;
  onClick: () => void;
}
```

**Exemplo:**
```tsx
<QuickActionButton
  icon={<Truck />}
  label="Demandas"
  badge={5}
  onClick={() => navigate('/app/delivery/requests')}
/>
```

---

## ü™ù API Hooks

### useDeliveryProfile()

**Localiza√ß√£o:** `apps/web/src/hooks/useDeliveryProfile.ts`

**Uso:** Gerencia o perfil de entregador do usu√°rio atual

**Retorno:**
```typescript
{
  profile: DeliveryProfile | null;
  loading: boolean;
  error: string | null;
  hasProfile: boolean;
  toggleAvailability: () => Promise<void>;
  refetch: () => Promise<void>;
}
```

**Exemplo:**
```tsx
function MyComponent() {
  const { profile, hasProfile, toggleAvailability } = useDeliveryProfile();

  if (!hasProfile) {
    return <Link to="/app/delivery/profile/setup">Criar Perfil</Link>;
  }

  return (
    <div>
      <p>Status: {profile.isAvailable ? 'Online' : 'Offline'}</p>
      <Button onClick={toggleAvailability}>Alternar</Button>
    </div>
  );
}
```

---

## üìä Tipos TypeScript

**Localiza√ß√£o:** `apps/web/src/types/delivery.ts`

### Enums

```typescript
enum DeliveryRequestStatus {
  PENDING = 'pending',
  ACCEPTED = 'accepted',
  PICKED_UP = 'picked_up',
  IN_TRANSIT = 'in_transit',
  DELIVERED = 'delivered',
  CANCELLED = 'cancelled',
}

enum PackageType {
  DOCUMENT = 'document',
  SMALL = 'small',
  MEDIUM = 'medium',
  LARGE = 'large',
}

enum VehicleType {
  BIKE = 'bike',
  MOTORCYCLE = 'motorcycle',
  CAR = 'car',
  VAN = 'van',
}
```

### Interfaces Principais

```typescript
interface DeliveryRequest {
  id: string;
  status: DeliveryRequestStatus;
  pickupAddress: Address;
  pickupContact: ContactInfo;
  deliveryAddress: Address;
  deliveryContact: ContactInfo;
  packageType: PackageType;
  weight: number;
  specialInstructions?: string;
  distance: number;
  estimatedTime: number;
  totalBzr: string;
  breakdown: FeeBreakdown;
  requesterId: string;
  delivererId?: string;
  orderId?: string;
  storeId?: string;
  deliverer?: DelivererInfo;
  createdAt: string;
  acceptedAt?: string;
  pickedUpAt?: string;
  deliveredAt?: string;
  cancelledAt?: string;
  cancelReason?: string;
}

interface DeliveryProfile {
  id: string;
  userId: string;
  fullName: string;
  cpf: string;
  phone: string;
  baseAddress: Address;
  profilePhoto?: string;
  vehicleType: VehicleType;
  vehicleBrand?: string;
  vehicleModel?: string;
  vehiclePlate?: string;
  vehicleColor?: string;
  maxCapacityKg: number;
  isAvailable: boolean;
  radiusKm: number;
  availableDays: DayOfWeek[];
  availableTimeSlots: TimeSlot[];
  acceptsImmediateDeliveries: boolean;
  activeDeliveries?: number;
  createdAt: string;
  updatedAt: string;
}

interface StoreDeliveryPartner {
  id: string;
  storeId: string;
  deliveryProfileId: string;
  priority: number;
  isActive: boolean;
  deliveryProfile: {
    fullName: string;
    phone: string;
    vehicleType: VehicleType;
    radiusKm: number;
    profilePhoto?: string;
  };
  stats?: {
    totalDeliveries: number;
    completionRate: number;
    averageRating: number;
  };
  createdAt: string;
  updatedAt: string;
}
```

---

## üåê API Endpoints

**Localiza√ß√£o:** `apps/web/src/lib/api/delivery.ts`

### Delivery Requests

| M√©todo | Endpoint | Descri√ß√£o |
|--------|----------|-----------|
| POST | `/api/delivery/requests/calculate-fee` | Calcular taxa de entrega |
| POST | `/api/delivery/requests` | Criar nova entrega |
| GET | `/api/delivery/requests` | Listar entregas (com filtros) |
| GET | `/api/delivery/requests/:id` | Obter entrega espec√≠fica |
| POST | `/api/delivery/requests/:id/accept` | Aceitar entrega |
| POST | `/api/delivery/requests/:id/pickup` | Confirmar coleta |
| POST | `/api/delivery/requests/:id/deliver` | Confirmar entrega |
| POST | `/api/delivery/requests/:id/cancel` | Cancelar entrega |

### Delivery Profile

| M√©todo | Endpoint | Descri√ß√£o |
|--------|----------|-----------|
| GET | `/api/delivery/profile` | Obter perfil do entregador |
| POST | `/api/delivery/profile` | Criar perfil de entregador |
| PUT | `/api/delivery/profile` | Atualizar perfil |
| PATCH | `/api/delivery/profile/availability` | Alterar disponibilidade |
| GET | `/api/delivery/profile/stats` | Obter estat√≠sticas |

### Store Partners

| M√©todo | Endpoint | Descri√ß√£o |
|--------|----------|-----------|
| GET | `/api/delivery/partners` | Listar parceiros da loja |
| POST | `/api/delivery/partners` | Convidar parceiro |
| PUT | `/api/delivery/partners/:id` | Atualizar parceiro |
| DELETE | `/api/delivery/partners/:id` | Remover parceiro |

---

## üóÇÔ∏è Estrutura de Arquivos

```
apps/web/src/
‚îú‚îÄ‚îÄ components/delivery/
‚îÇ   ‚îú‚îÄ‚îÄ AddressCard.tsx
‚îÇ   ‚îú‚îÄ‚îÄ DeliveryStatusTimeline.tsx
‚îÇ   ‚îú‚îÄ‚îÄ FeeBreakdownCard.tsx
‚îÇ   ‚îú‚îÄ‚îÄ KPICard.tsx
‚îÇ   ‚îú‚îÄ‚îÄ QuickActionButton.tsx
‚îÇ   ‚îú‚îÄ‚îÄ StepIndicator.tsx
‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îî‚îÄ‚îÄ useDeliveryProfile.ts
‚îú‚îÄ‚îÄ lib/api/
‚îÇ   ‚îî‚îÄ‚îÄ delivery.ts
‚îú‚îÄ‚îÄ pages/delivery/
‚îÇ   ‚îú‚îÄ‚îÄ ActiveDeliveryPage.tsx
‚îÇ   ‚îú‚îÄ‚îÄ ComponentsTestPage.tsx
‚îÇ   ‚îú‚îÄ‚îÄ DeliveryDashboardPage.tsx
‚îÇ   ‚îú‚îÄ‚îÄ DeliveryEarningsPage.tsx
‚îÇ   ‚îú‚îÄ‚îÄ DeliveryHistoryPage.tsx
‚îÇ   ‚îú‚îÄ‚îÄ DeliveryLandingPage.tsx
‚îÇ   ‚îú‚îÄ‚îÄ DeliveryPartnersPage.tsx
‚îÇ   ‚îú‚îÄ‚îÄ DeliveryProfileSetupPage.tsx
‚îÇ   ‚îú‚îÄ‚îÄ DeliveryRequestDetailPage.tsx
‚îÇ   ‚îú‚îÄ‚îÄ DeliveryRequestsListPage.tsx
‚îÇ   ‚îî‚îÄ‚îÄ RequestDeliveryPage.tsx
‚îî‚îÄ‚îÄ types/
    ‚îî‚îÄ‚îÄ delivery.ts
```

---

## üîó Integra√ß√µes

### DashboardPage
- Quick Action "Virar Entregador" (sem perfil)
- Quick Action "Minhas Entregas" (com perfil)
- Badge com n√∫mero de entregas ativas

### OrderPage
- Card de rastreamento de entrega (se pedido tiver deliveryRequestId)
- Timeline de status
- Informa√ß√µes do entregador
- Bot√£o "Ver Detalhes da Entrega"

### MobileBottomNav
- Aba "Entregas" para entregadores (s√≥ aparece se tem perfil)
- Badge com entregas ativas
- √çcone de caminh√£o

---

## üé® Design System

### Cores

- **Primary**: Tema do Bazari (vinho/purple)
- **Delivery**: Verde esmeralda (`emerald-500`)
- **Status Colors**:
  - Pending: Cinza (`muted`)
  - Accepted: Azul (`blue-500`)
  - Picked Up: Amarelo (`yellow-500`)
  - In Transit: Roxo (`purple-500`)
  - Delivered: Verde (`green-500`)
  - Cancelled: Vermelho (`red-500`)

### √çcones (Lucide React)

- Truck: Entregas gerais
- Package: Pacotes
- MapPin: Localiza√ß√£o
- Phone: Telefone
- Navigation: GPS
- Star: Avalia√ß√£o
- TrendingUp: Estat√≠sticas
- Clock: Tempo

---

## üß™ Testes

### Fluxos Cr√≠ticos para Testar

1. **Solicitar Entrega**: Preencher 3 steps e confirmar
2. **Criar Perfil de Entregador**: Completar 4 steps
3. **Aceitar e Completar Entrega**: Do marketplace at√© delivered
4. **Gerenciar Parceiros**: Convidar, priorizar, remover
5. **Integra√ß√µes**: Dashboard, OrderPage, MobileBottomNav

### Casos de Erro

- Formul√°rio incompleto
- Taxa n√£o calculada
- Entrega j√° aceita por outro
- Perfil j√° existe
- ID de parceiro inv√°lido

---

## üöÄ Melhorias Futuras

- [ ] Sistema de avalia√ß√£o (rating) de entregadores
- [ ] Notifica√ß√µes push para novas demandas
- [ ] Rastreamento GPS em tempo real
- [ ] Chat in-app entre solicitante e entregador
- [ ] Hist√≥rico detalhado com filtros avan√ßados
- [ ] Exporta√ß√£o de relat√≥rios de ganhos
- [ ] Gamifica√ß√£o (badges, n√≠veis, conquistas)
- [ ] Sistema de disputa e media√ß√£o
- [ ] Seguro de entregas
- [ ] Multi-idioma (i18n)

---

## üìÑ Licen√ßa

Parte do ecossistema Bazari - Todos os direitos reservados.

---

## üë• Contribuidores

Sistema desenvolvido por: Claude (Anthropic)
Para: Equipe Bazari

**Data de Conclus√£o:** Outubro 2025
**Vers√£o:** 1.0.0
